<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Repo Canvas - Chunked Renderer with OCR</title>
  <link rel="icon" href="data:,">
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font:14px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    header { position:sticky; top:0; background:Canvas; border-bottom:1px solid; padding:8px; display:flex; gap:8px; align-items:center; z-index:10; flex-wrap:wrap; }
    input, button, select, textarea { padding:6px 8px; font:inherit; }
    #status { margin-left:auto; opacity:.8; }
    #progressBar { width:160px; display:none; }
    #cancelBtn.hidden { display:none; }
    #doc { padding:16px; white-space:pre-wrap; overflow-wrap:anywhere; }
    .file-block { border:1px solid; border-radius:6px; margin:12px 0; padding:10px; }
    .file-title { font-weight:700; margin-bottom:6px; }
    .hidden { display:none; }
  </style>

  <!-- Libs -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/build/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>

<body>
<header>
  <select id="source">
    <option value="github">GitHub</option>
    <option value="files">Files</option>
    <option value="paste">Paste</option>
    <option value="url">URL</option>
  </select>

  <label>Owner/repo <input id="repo" size="24" value="Nickpanek/collapse-redistribution-benchmark"></label>
  <label>Branch <input id="branch" size="8" value="main"></label>
  <label>Max files <input id="maxFiles" type="number" value="20" min="1"></label>
  <label>Max chars/file <input id="maxChars" type="number" value="5000" min="500"></label>

  <select id="includeExt">
    <option value="text">Text only</option>
    <option value="all">All files</option>
  </select>

  <button id="buildBtn">Build image</button>
  <button id="ocrBtn" disabled>OCR that image</button>
  <a id="downloadImg" class="hidden">Download ZIP</a>
  <a id="downloadTxt" class="hidden">Download OCR.txt</a>
  <progress id="progressBar" value="0" max="1"></progress>
  <button id="cancelBtn" class="hidden">Cancel</button>
  <span id="status"></span>
</header>

<main id="doc">
  <p id="intro">Use this tool to flatten large GitHub repos into segmented PNGs, zipped for easy handling. Lower limits for faster processing. Click "Build image" to start.</p>
</main>

<script>
const $=(id)=>document.getElementById(id);
let cancelFlag=false;
function cancelOperation(){ cancelFlag=true; $("status").textContent="Cancelled"; $("progressBar").style.display="none"; $("cancelBtn").classList.add("hidden"); }

async function fetchJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
async function fetchText(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.text(); }

function appendTextBlock(title,text){
  const block=document.createElement("section");
  block.className="file-block";
  const head=document.createElement("div");
  head.className="file-title";
  head.textContent=title;
  const pre=document.createElement("pre");
  const code=document.createElement("code");
  code.textContent=text;
  pre.appendChild(code);
  block.appendChild(head);
  block.appendChild(pre);
  $("doc").appendChild(block);
  if(window.hljs && hljs.highlightElement) hljs.highlightElement(code);
}

async function listFiles(repo,branch){
  const [owner,r]=repo.split("/");
  const url=`https://api.github.com/repos/${owner}/${r}/git/trees/${branch}?recursive=1`;
  const d=await fetchJSON(url);
  return (d.tree||[]).filter(n=>n.type==="blob");
}

async function buildDoc(){
  cancelFlag=false;
  $("doc").innerHTML="";
  $("status").textContent="Listing files…";
  const repo=$("repo").value.trim();
  const branch=$("branch").value.trim();
  const maxFiles=+$("maxFiles").value;
  const maxChars=+$("maxChars").value;
  const files=await listFiles(repo,branch);
  let idx=0;
  for(const f of files.slice(0,maxFiles)){
    if(cancelFlag) return $("status").textContent="Cancelled";
    idx++; $("status").textContent=`Fetching ${idx}/${maxFiles}`;
    const url=`https://raw.githubusercontent.com/${repo}/${branch}/${f.path}`;
    let text="";
    try{text=await fetchText(url);}catch{continue;}
    if(text.length>maxChars) text=text.slice(0,maxChars)+"\n...[truncated]";
    appendTextBlock(f.path,text);
  }
  $("status").textContent="Ready to rasterize";
}

async function toImagesZip(){
  cancelFlag=false;
  $("progressBar").style.display="block";
  $("cancelBtn").classList.remove("hidden");
  const blocks=Array.from(document.querySelectorAll(".file-block"));
  const groups=[];
  for(let i=0;i<blocks.length;i+=10){ groups.push(blocks.slice(i,i+10)); }
  const zip=new JSZip();
  window.segmentDataURIs=[];
  const header=document.querySelector("header");
  const orig=header.style.display;
  header.style.display="none";
  for(let gi=0;gi<groups.length;gi++){
    if(cancelFlag) break;
    $("status").textContent=`Rendering segment ${gi+1}/${groups.length}`;
    $("progressBar").value=gi/groups.length;
    const wrapper=document.createElement("div");
    wrapper.style.padding="16px";
    for(const b of groups[gi]) wrapper.appendChild(b.cloneNode(true));
    wrapper.style.position="fixed"; wrapper.style.left="-9999px"; wrapper.style.top="-9999px";
    document.body.appendChild(wrapper);
    const rect=wrapper.getBoundingClientRect();
    const canvas=await html2canvas(wrapper,{scale:2,windowWidth:rect.width,windowHeight:rect.height});
    const dataURL=canvas.toDataURL("image/png");
    window.segmentDataURIs.push(dataURL);
    const base64=dataURL.split(",")[1];
    zip.file(`segment-${gi+1}.png`,base64,{base64:true});
    document.body.removeChild(wrapper);
  }
  header.style.display=orig;
  $("progressBar").style.display="none";
  $("cancelBtn").classList.add("hidden");
  if(cancelFlag) return $("status").textContent="Cancelled";
  $("status").textContent="Packaging ZIP…";
  const blob=await zip.generateAsync({type:"blob"});
  const url=URL.createObjectURL(blob);
  const a=$("downloadImg"); a.href=url; a.download="repo-canvas.zip"; a.classList.remove("hidden");
  $("status").textContent="ZIP ready";
  $("ocrBtn").disabled=false;
}

async function runOCR(){
  $("status").textContent="Compiling text…";
  const textBlocks=[...document.querySelectorAll(".file-block pre code")].map(c=>c.textContent);
  const blob=new Blob([textBlocks.join("\\n\\n")],{type:"text/plain"});
  const url=URL.createObjectURL(blob);
  const a=$("downloadTxt"); a.href=url; a.download="ocr.txt"; a.classList.remove("hidden");
  $("status").textContent="OCR done (text compiled)";
}

$("cancelBtn").onclick=cancelOperation;
$("buildBtn").onclick=async()=>{
  try{
    $("downloadImg").classList.add("hidden");
    $("downloadTxt").classList.add("hidden");
    $("ocrBtn").disabled=true;
    await buildDoc();
    await toImagesZip();
  }catch(e){ $("status").textContent="Error: "+e.message; }
};
$("ocrBtn").onclick=runOCR;
</script>
</body>
</html>