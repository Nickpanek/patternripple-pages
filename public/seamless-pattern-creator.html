<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seamless Pattern Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Courier New', Courier, monospace;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #4ade80;
        }
        .modal {
            display: none;
            backdrop-filter: blur(8px);
        }
        .modal.show {
            display: flex;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        canvas {
            cursor: crosshair;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border-radius: 0;
        }
        canvas.grab-cursor {
            cursor: grab;
        }
        canvas.grabbing-cursor {
            cursor: grabbing;
        }
        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(148, 163, 184, 0.1), transparent);
            margin: 1.5rem 0;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-track {
            background: #334155;
            height: 6px;
            border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            height: 18px;
            width: 18px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 2px 8px rgba(74, 222, 128, 0.4);
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.6);
        }
        input[type="range"]::-moz-range-track {
            background: #334155;
            height: 6px;
            border-radius: 3px;
        }
        input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            height: 18px;
            width: 18px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(74, 222, 128, 0.4);
        }
        input[type="color"] {
            cursor: pointer;
            border: 2px solid #334155;
            transition: all 0.15s ease;
        }
        input[type="color"]:hover {
            border-color: #4ade80;
        }
        input[type="checkbox"] {
            cursor: pointer;
            accent-color: #4ade80;
        }
        button {
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        button:hover {
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        .control-group {
            background: rgba(51, 65, 85, 0.3);
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .canvas-container {
            position: relative;
            display: inline-block;
        }
        .canvas-hint {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(15, 23, 42, 0.95);
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: #4ade80;
            pointer-events: none;
            border: 1px solid rgba(74, 222, 128, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .badge {
            display: inline-block;
            background: rgba(74, 222, 128, 0.15);
            color: #4ade80;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.025em;
        }
        kbd {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.25rem;
            padding: 0.125rem 0.375rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.75rem;
            color: #4ade80;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        .selection-wrapper {
            min-height: 550px;
        }
        #selection-controls {
            transition: opacity 0.2s ease;
        }
        #selection-controls.hidden {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            visibility: hidden;
        }
        .selection-placeholder {
            min-height: 550px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .selection-placeholder.hidden {
            display: none;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold mb-2">
                <span class="bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">Pattern Creator</span>
            </h1>
            <p class="text-green-500 text-sm">Create seamless, repeating patterns • Free for makers</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Sidebar Controls -->
            <aside class="w-full lg:w-80 bg-slate-800/50 backdrop-blur-sm p-6 rounded-2xl shadow-2xl border border-slate-700/50 flex flex-col gap-6 h-fit">
                
                <!-- Quick Start -->
                <div class="control-group">
                    <h2 class="text-xs font-bold text-green-400 uppercase tracking-wider mb-3">Quick Start</h2>
                    <div class="text-sm text-green-300 space-y-2 leading-relaxed">
                        <p>Press a key to create shapes:</p>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div><kbd>C</kbd> Circle</div>
                            <div><kbd>S</kbd> Square</div>
                            <div><kbd>T</kbd> Triangle</div>
                            <div><kbd>H</kbd> Hexagon</div>
                            <div><kbd>P</kbd> Pentagon</div>
                            <div><kbd>R</kbd> Star</div>
                            <div><kbd>U</kbd> Upload image</div>
                            <div><kbd>V</kbd> Select mode</div>
                        </div>
                        <p class="text-xs text-green-500 mt-3">Then click on canvas to place. Click and drag to move shapes.</p>
                    </div>
                </div>

                <input type="file" id="image-upload" accept="image/*" class="hidden">
                
                <!-- Canvas Background -->
                <div class="control-group">
                    <h2 class="text-xs font-bold text-green-400 uppercase tracking-wider mb-3">Canvas Background</h2>
                    <div class="flex items-center gap-3">
                        <input type="color" id="bg-color-picker" value="#ffffff" class="bg-slate-700 rounded-lg p-1 h-10 w-20 border-none">
                        <div class="flex-1">
                            <div class="text-xs text-green-500">Pattern base color</div>
                        </div>
                    </div>
                </div>

                <!-- Shape Properties -->
                <div class="selection-wrapper">
                    <div id="selection-placeholder" class="selection-placeholder control-group">
                        <div class="text-center text-green-600">
                            <svg class="inline w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/></svg>
                            <p class="text-sm">Select a shape to edit</p>
                        </div>
                    </div>
                <div id="selection-controls" class="hidden">
                    <div class="control-group">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xs font-bold text-green-400 uppercase tracking-wider">Shape Properties</h2>
                            <span class="badge" id="shape-type-badge">Circle</span>
                        </div>
                        <div class="flex flex-col gap-4">
                            <div class="flex items-center gap-3">
                                <input type="color" id="color-picker" class="bg-slate-700 rounded-lg p-1 h-10 w-20 border-none">
                                <div class="flex-1">
                                    <div class="text-xs text-green-500 mb-1">Fill Color</div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-xs text-green-400 font-medium">Size</label>
                                    <span class="text-xs font-mono text-green-300"><span id="size-value">50</span>px</span>
                                </div>
                                <input type="range" id="size-slider" min="5" max="200" value="50" class="w-full">
                                <div class="text-xs text-green-600 mt-1">Drag slider to resize shape/image</div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-xs text-green-400 font-medium">Opacity</label>
                                    <span class="text-xs font-mono text-green-300"><span id="opacity-value">100</span>%</span>
                                </div>
                                <input type="range" id="opacity-slider" min="0" max="100" value="100" class="w-full">
                            </div>
                            
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-xs text-green-400 font-medium">Rotation</label>
                                    <span class="text-xs font-mono text-green-300"><span id="rotation-value">0</span>°</span>
                                </div>
                                <input type="range" id="rotation-slider" min="0" max="360" value="0" class="w-full">
                            </div>

                            <div class="section-divider"></div>
                            
                            <div>
                                <div class="text-xs text-green-400 font-medium mb-2">Layer Order</div>
                                <div class="grid grid-cols-2 gap-2">
                                    <button id="bring-forward-btn" class="p-2.5 bg-slate-700/70 hover:bg-slate-600 text-green-300 text-xs font-medium rounded-lg">
                                        <svg class="inline w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
                                        Forward
                                    </button>
                                    <button id="send-backward-btn" class="p-2.5 bg-slate-700/70 hover:bg-slate-600 text-green-300 text-xs font-medium rounded-lg">
                                        <svg class="inline w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                                        Backward
                                    </button>
                                </div>
                            </div>
                            
                            <button id="duplicate-btn" class="w-full p-2.5 bg-emerald-600 hover:bg-emerald-500 text-green-100 font-semibold rounded-lg shadow-lg shadow-emerald-600/20">
                                <svg class="inline w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                Duplicate <kbd class="ml-1">Ctrl+D</kbd>
                            </button>
                            <button id="delete-btn" class="w-full p-2.5 bg-red-600 hover:bg-red-500 text-green-100 font-semibold rounded-lg shadow-lg shadow-red-600/20">
                                <svg class="inline w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                Delete <kbd class="ml-1">Del</kbd>
                            </button>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- Grid Settings -->
                <div class="control-group">
                    <h2 class="text-xs font-bold text-green-400 uppercase tracking-wider mb-3">Grid Settings</h2>
                    <div class="flex flex-col gap-3">
                        <label class="flex items-center justify-between cursor-pointer group">
                            <span class="text-sm text-green-300 group-hover:text-green-100 transition-colors">Show Grid</span>
                            <input type="checkbox" id="grid-toggle" class="w-5 h-5 rounded">
                        </label>
                        <label class="flex items-center justify-between cursor-pointer group">
                            <span class="text-sm text-green-300 group-hover:text-green-100 transition-colors">Snap to Grid</span>
                            <input type="checkbox" id="snap-toggle" class="w-5 h-5 rounded">
                        </label>
                    </div>
                </div>

                <div class="section-divider"></div>
                
                <!-- Actions -->
                <div>
                    <h2 class="text-xs font-bold text-green-400 uppercase tracking-wider mb-3">Actions</h2>
                    <div class="flex flex-col gap-2">
                        <div class="grid grid-cols-2 gap-2">
                            <button id="undo-btn" class="p-2.5 bg-slate-700/70 hover:bg-slate-600 text-green-300 font-semibold rounded-lg">
                                <svg class="inline w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
                                Undo
                            </button>
                            <button id="redo-btn" class="p-2.5 bg-slate-700/70 hover:bg-slate-600 text-green-300 font-semibold rounded-lg">
                                <svg class="inline w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10H11a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"/></svg>
                                Redo
                            </button>
                        </div>
                        <button id="preview-btn" class="w-full p-3 bg-indigo-600 hover:bg-indigo-500 text-green-100 font-bold rounded-lg shadow-lg shadow-indigo-600/30">
                            <svg class="inline w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                            Preview Pattern
                        </button>
                        <button id="export-btn" class="w-full p-3 bg-purple-600 hover:bg-purple-500 text-green-100 font-bold rounded-lg shadow-lg shadow-purple-600/30">
                            <svg class="inline w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            Export PNG
                        </button>
                        <button id="clear-btn" class="w-full p-2.5 bg-slate-700/50 hover:bg-slate-600 text-green-300 hover:text-green-100 font-semibold rounded-lg">Clear All</button>
                    </div>
                </div>
                
                <!-- Keyboard Shortcuts -->
                <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700/30">
                    <div class="text-xs font-bold text-green-400 uppercase tracking-wider mb-3">All Keyboard Shortcuts</div>
                    <div class="text-xs text-green-500 space-y-1.5 leading-relaxed">
                        <div class="flex justify-between"><span>Select tool</span><kbd>V</kbd></div>
                        <div class="flex justify-between"><span>Circle</span><kbd>C</kbd></div>
                        <div class="flex justify-between"><span>Square</span><kbd>S</kbd></div>
                        <div class="flex justify-between"><span>Triangle</span><kbd>T</kbd></div>
                        <div class="flex justify-between"><span>Star</span><kbd>R</kbd></div>
                        <div class="flex justify-between"><span>Hexagon</span><kbd>H</kbd></div>
                        <div class="flex justify-between"><span>Pentagon</span><kbd>P</kbd></div>
                        <div class="flex justify-between"><span>Upload image</span><kbd>U</kbd></div>
                        <div class="section-divider my-2"></div>
                        <div class="flex justify-between"><span>Undo</span><kbd>Ctrl+Z</kbd></div>
                        <div class="flex justify-between"><span>Redo</span><kbd>Ctrl+Y</kbd></div>
                        <div class="flex justify-between"><span>Duplicate</span><kbd>Ctrl+D</kbd></div>
                        <div class="flex justify-between"><span>Delete</span><kbd>Del</kbd></div>
                        <div class="flex justify-between"><span>Nudge shape</span><kbd>↑↓←→</kbd></div>
                        <div class="text-green-700 text-xs mt-1">Hold Shift for 10px nudge</div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Credits & Download -->
                <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700/30">
                    <div class="text-xs text-green-500 text-center mb-3">
                        Made by <a href="https://heylink.me/nickpanek/" target="_blank" class="text-green-400 hover:text-green-300 underline font-semibold">Nick Panek</a>
                        <br>
                        <a href="https://patternripple.com" target="_blank" class="text-green-600 hover:text-green-400">PatternRipple.com</a>
                    </div>
                    <button id="download-tool-btn" class="w-full p-2.5 bg-green-700/20 hover:bg-green-700/30 text-green-400 hover:text-green-300 font-semibold rounded-lg border border-green-700/30 transition-colors">
                        <svg class="inline w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Download Tool (Offline)
                    </button>
                </div>
            </aside>

            <!-- Canvas Area -->
            <main class="flex-1 flex flex-col bg-slate-800/30 backdrop-blur-sm rounded-2xl p-8 shadow-2xl border border-slate-700/50">
                <div class="canvas-container mb-auto">
                    <div class="canvas-hint" id="canvas-hint">
                        <span id="canvas-hint-text">Press <kbd>C</kbd>, <kbd>S</kbd>, <kbd>T</kbd>, or <kbd>U</kbd> to create shapes</span>
                    </div>
                    <canvas id="pattern-canvas" width="500" height="500" class="bg-white"></canvas>
                </div>
            </main>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="modal fixed inset-0 bg-black/80 items-center justify-center p-4 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 w-full max-w-5xl shadow-2xl border border-slate-700 relative">
            <h2 class="text-3xl font-bold mb-6 text-center">
                <span class="bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">Pattern Preview</span>
            </h2>
            <div id="preview-container" class="w-full h-[65vh] bg-slate-900 rounded-xl overflow-hidden border-2 border-slate-700">
            </div>
            <button id="close-modal-btn" class="absolute top-6 right-6 text-green-400 hover:text-green-200 bg-slate-700 hover:bg-slate-600 rounded-lg p-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('pattern-canvas');
        const ctx = canvas.getContext('2d');
        
        const selectionControls = document.getElementById('selection-controls');
        const selectionPlaceholder = document.getElementById('selection-placeholder');
        const colorPicker = document.getElementById('color-picker');
        const sizeSlider = document.getElementById('size-slider');
        const sizeValue = document.getElementById('size-value');
        const opacitySlider = document.getElementById('opacity-slider');
        const opacityValue = document.getElementById('opacity-value');
        const rotationSlider = document.getElementById('rotation-slider');
        const rotationValue = document.getElementById('rotation-value');
        const deleteBtn = document.getElementById('delete-btn');
        const duplicateBtn = document.getElementById('duplicate-btn');
        const clearBtn = document.getElementById('clear-btn');
        const previewBtn = document.getElementById('preview-btn');
        const exportBtn = document.getElementById('export-btn');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        const bringForwardBtn = document.getElementById('bring-forward-btn');
        const sendBackwardBtn = document.getElementById('send-backward-btn');
        const previewModal = document.getElementById('preview-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const previewContainer = document.getElementById('preview-container');
        const bgColorPicker = document.getElementById('bg-color-picker');
        const gridToggle = document.getElementById('grid-toggle');
        const snapToggle = document.getElementById('snap-toggle');
        const imageUpload = document.getElementById('image-upload');
        const canvasHint = document.getElementById('canvas-hint');
        const canvasHintText = document.getElementById('canvas-hint-text');
        const shapeTypeBadge = document.getElementById('shape-type-badge');
        const downloadToolBtn = document.getElementById('download-tool-btn');

        let shapes = [];
        let history = [];
        let historyIndex = -1;
        let activeTool = 'select';
        let selectedShape = null;
        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        let nextColor = '#6366f1';
        let backgroundColor = '#ffffff';
        let showGrid = false;
        let snapToGrid = false;
        const gridSize = 20;
        const loadedImages = {};

        shapes.push({ id: 1, type: 'circle', x: 100, y: 100, radius: 40, color: '#ec4899', opacity: 1, rotation: 0 });
        shapes.push({ id: 2, type: 'square', x: 400, y: 400, size: 70, color: '#f59e0b', opacity: 1, rotation: 0 });
        shapes.push({ id: 3, type: 'triangle', x: 250, y: 250, size: 80, color: '#10b981', opacity: 1, rotation: 0 });
        saveToHistory();
        updateCanvasHint();

        function saveToHistory() {
            history = history.slice(0, historyIndex + 1);
            history.push(JSON.parse(JSON.stringify(shapes)));
            historyIndex++;
            if (history.length > 50) {
                history.shift();
                historyIndex--;
            }
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                shapes = JSON.parse(JSON.stringify(history[historyIndex]));
                selectedShape = null;
                updateSelectionUI();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                shapes = JSON.parse(JSON.stringify(history[historyIndex]));
                selectedShape = null;
                updateSelectionUI();
            }
        }

        function draw() {
            ctx.fillStyle = backgroundColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (showGrid) {
                ctx.strokeStyle = 'rgba(100, 116, 139, 0.15)';
                ctx.lineWidth = 1;
                for (let x = 0; x <= canvas.width; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                for (let y = 0; y <= canvas.height; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
            }
            
            shapes.forEach(shape => {
                for (let i = -1; i <= 1; i++) {
                    for (let j = -1; j <= 1; j++) {
                        drawShape(shape, shape.x + i * canvas.width, shape.y + j * canvas.height);
                    }
                }
            });

            if (selectedShape) {
                ctx.strokeStyle = '#4ade80';
                ctx.lineWidth = 3;
                ctx.setLineDash([8, 4]);
                
                for (let i = -1; i <= 1; i++) {
                    for (let j = -1; j <= 1; j++) {
                       const ox = i * canvas.width;
                       const oy = j * canvas.height;
                        
                       ctx.save();
                       ctx.translate(selectedShape.x + ox, selectedShape.y + oy);
                       ctx.rotate((selectedShape.rotation || 0) * Math.PI / 180);
                       
                       ctx.beginPath();
                       const pad = 6;
                       if (selectedShape.type === 'circle') {
                           ctx.arc(0, 0, selectedShape.radius + pad, 0, Math.PI * 2);
                       } else if (selectedShape.type === 'square') {
                           const s = selectedShape.size;
                           ctx.rect(-s/2 - pad, -s/2 - pad, s + pad*2, s + pad*2);
                       } else if (selectedShape.type === 'triangle') {
                            const h = selectedShape.size * (Math.sqrt(3)/2);
                            ctx.moveTo(0, -h/2 - pad);
                            ctx.lineTo(-selectedShape.size/2 - pad, h/2 + pad);
                            ctx.lineTo(selectedShape.size/2 + pad, h/2 + pad);
                            ctx.closePath();
                       } else {
                            const r = (selectedShape.size || 80) / 2 + pad;
                            ctx.arc(0, 0, r, 0, Math.PI * 2);
                       }
                       ctx.stroke();
                       ctx.restore();
                    }
                }
                ctx.setLineDash([]);
            }
            
            requestAnimationFrame(draw);
        }

        function drawShape(shape, x, y) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate((shape.rotation || 0) * Math.PI / 180);
            ctx.globalAlpha = shape.opacity || 1;
            ctx.fillStyle = shape.color;
            ctx.beginPath();
            
            if (shape.type === 'circle') {
                ctx.arc(0, 0, shape.radius, 0, Math.PI * 2);
                ctx.fill();
            } else if (shape.type === 'square') {
                ctx.fillRect(-shape.size/2, -shape.size/2, shape.size, shape.size);
            } else if (shape.type === 'triangle') {
                const h = shape.size * (Math.sqrt(3)/2);
                ctx.moveTo(0, -h/2);
                ctx.lineTo(-shape.size/2, h/2);
                ctx.lineTo(shape.size/2, h/2);
                ctx.closePath();
                ctx.fill();
            } else if (shape.type === 'star') {
                drawStar(0, 0, 5, shape.size/2, shape.size/4);
                ctx.fill();
            } else if (shape.type === 'hexagon') {
                drawPolygon(0, 0, 6, shape.size/2);
                ctx.fill();
            } else if (shape.type === 'pentagon') {
                drawPolygon(0, 0, 5, shape.size/2);
                ctx.fill();
            } else if (shape.type === 'image' && shape.imageData) {
                const img = loadedImages[shape.imageData];
                if (img && img.complete) {
                    const s = shape.size || 80;
                    ctx.drawImage(img, -s/2, -s/2, s, s);
                }
            }
            
            ctx.restore();
        }

        function drawStar(cx, cy, spikes, outer, inner) {
            let rot = Math.PI / 2 * 3;
            const step = Math.PI / spikes;
            ctx.moveTo(cx, cy - outer);
            for (let i = 0; i < spikes; i++) {
                let x = cx + Math.cos(rot) * outer;
                let y = cy + Math.sin(rot) * outer;
                ctx.lineTo(x, y);
                rot += step;
                x = cx + Math.cos(rot) * inner;
                y = cy + Math.sin(rot) * inner;
                ctx.lineTo(x, y);
                rot += step;
            }
            ctx.lineTo(cx, cy - outer);
            ctx.closePath();
        }

        function drawPolygon(cx, cy, sides, radius) {
            const angle = (2 * Math.PI) / sides;
            for (let i = 0; i < sides; i++) {
                const x = cx + radius * Math.cos(i * angle - Math.PI/2);
                const y = cy + radius * Math.sin(i * angle - Math.PI/2);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
        }

        canvas.addEventListener('mousedown', (e) => {
            const pos = getMousePos(e);

            if (activeTool === 'select') {
                const clicked = getShapeAt(pos.x, pos.y);
                if (clicked) {
                    selectedShape = clicked;
                    isDragging = true;
                    dragOffsetX = pos.x - selectedShape.x;
                    dragOffsetY = pos.y - selectedShape.y;
                    updateSelectionUI();
                    canvas.classList.add('grabbing-cursor');
                } else {
                    selectedShape = null;
                    updateSelectionUI();
                }
            } else {
                const snapped = snapToGrid ? {
                    x: Math.round(pos.x / gridSize) * gridSize,
                    y: Math.round(pos.y / gridSize) * gridSize
                } : pos;
                
                const newShape = {
                    id: Date.now(),
                    type: activeTool,
                    x: snapped.x,
                    y: snapped.y,
                    color: nextColor,
                    opacity: 1,
                    rotation: 0
                };
                if (activeTool === 'circle') newShape.radius = 40;
                else newShape.size = 80;

                shapes.push(newShape);
                selectedShape = newShape;
                activeTool = 'select';
                updateSelectionUI();
                saveToHistory();
                updateCanvasHint();
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            const pos = getMousePos(e);
            
            if (activeTool === 'select' && !isDragging) {
                canvas.classList.toggle('grab-cursor', !!getShapeAt(pos.x, pos.y));
            }

            if (isDragging && selectedShape) {
                let newX = pos.x - dragOffsetX;
                let newY = pos.y - dragOffsetY;
                
                if (snapToGrid) {
                    newX = Math.round(newX / gridSize) * gridSize;
                    newY = Math.round(newY / gridSize) * gridSize;
                }
                
                selectedShape.x = (newX % canvas.width + canvas.width) % canvas.width;
                selectedShape.y = (newY % canvas.height + canvas.height) % canvas.height;
            }
        });

        canvas.addEventListener('mouseup', () => {
            if (isDragging) saveToHistory();
            isDragging = false;
            canvas.classList.remove('grabbing-cursor');
        });
        
        canvas.addEventListener('mouseleave', () => {
            if (isDragging) saveToHistory();
            isDragging = false;
            canvas.classList.remove('grabbing-cursor', 'grab-cursor');
        });

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const id = 'img_' + Date.now();
                        loadedImages[id] = img;
                        
                        shapes.push({
                            id: Date.now(),
                            type: 'image',
                            x: canvas.width/2,
                            y: canvas.height/2,
                            size: 100,
                            imageData: id,
                            color: '#ffffff',
                            opacity: 1,
                            rotation: 0
                        });
                        
                        selectedShape = shapes[shapes.length - 1];
                        activeTool = 'select';
                        updateSelectionUI();
                        saveToHistory();
                        updateCanvasHint();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
            imageUpload.value = '';
        });

        function updateCanvasHint() {
            const hints = {
                'select': 'Click and drag shapes to move them',
                'circle': 'Click anywhere to place a circle',
                'square': 'Click anywhere to place a square',
                'triangle': 'Click anywhere to place a triangle',
                'star': 'Click anywhere to place a star',
                'hexagon': 'Click anywhere to place a hexagon',
                'pentagon': 'Click anywhere to place a pentagon'
            };
            const hintHTML = hints[activeTool] || 'Press <kbd>C</kbd>, <kbd>S</kbd>, <kbd>T</kbd>, or <kbd>U</kbd> to create shapes';
            canvasHintText.innerHTML = hintHTML;
        }

        colorPicker.addEventListener('input', (e) => {
            if (selectedShape) {
                selectedShape.color = e.target.value;
                saveToHistory();
            }
            nextColor = e.target.value;
        });
        
        sizeSlider.addEventListener('input', (e) => {
            const v = parseInt(e.target.value);
            sizeValue.textContent = v;
            if (selectedShape) {
                if (selectedShape.type === 'circle') {
                    selectedShape.radius = v / 2;
                } else {
                    selectedShape.size = v;
                }
            }
        });
        sizeSlider.addEventListener('mouseup', () => {
            if (selectedShape) saveToHistory();
        });

        opacitySlider.addEventListener('input', (e) => {
            const v = parseInt(e.target.value);
            opacityValue.textContent = v;
            if (selectedShape) {
                selectedShape.opacity = v / 100;
            }
        });
        opacitySlider.addEventListener('mouseup', () => {
            if (selectedShape) saveToHistory();
        });

        rotationSlider.addEventListener('input', (e) => {
            const v = parseInt(e.target.value);
            rotationValue.textContent = v;
            if (selectedShape) {
                selectedShape.rotation = v;
            }
        });
        rotationSlider.addEventListener('mouseup', () => {
            if (selectedShape) saveToHistory();
        });

        deleteBtn.addEventListener('click', () => {
            if (selectedShape) {
                shapes = shapes.filter(s => s.id !== selectedShape.id);
                selectedShape = null;
                updateSelectionUI();
                saveToHistory();
            }
        });

        duplicateBtn.addEventListener('click', () => {
            if (selectedShape) {
                const dup = JSON.parse(JSON.stringify(selectedShape));
                dup.id = Date.now();
                dup.x = (dup.x + 20) % canvas.width;
                dup.y = (dup.y + 20) % canvas.height;
                shapes.push(dup);
                selectedShape = dup;
                updateSelectionUI();
                saveToHistory();
            }
        });

        bringForwardBtn.addEventListener('click', () => {
            if (selectedShape) {
                const idx = shapes.findIndex(s => s.id === selectedShape.id);
                if (idx < shapes.length - 1) {
                    [shapes[idx], shapes[idx + 1]] = [shapes[idx + 1], shapes[idx]];
                    saveToHistory();
                }
            }
        });

        sendBackwardBtn.addEventListener('click', () => {
            if (selectedShape) {
                const idx = shapes.findIndex(s => s.id === selectedShape.id);
                if (idx > 0) {
                    [shapes[idx], shapes[idx - 1]] = [shapes[idx - 1], shapes[idx]];
                    saveToHistory();
                }
            }
        });
        
        clearBtn.addEventListener('click', () => {
            if (confirm('Clear all shapes? This cannot be undone.')) {
                shapes = [];
                selectedShape = null;
                updateSelectionUI();
                saveToHistory();
            }
        });

        undoBtn.addEventListener('click', undo);
        redoBtn.addEventListener('click', redo);

        bgColorPicker.addEventListener('input', (e) => {
            backgroundColor = e.target.value;
        });

        gridToggle.addEventListener('change', (e) => {
            showGrid = e.target.checked;
        });

        snapToggle.addEventListener('change', (e) => {
            snapToGrid = e.target.checked;
        });

        previewBtn.addEventListener('click', () => {
            const url = canvas.toDataURL();
            previewContainer.style.backgroundImage = `url(${url})`;
            previewContainer.style.backgroundRepeat = 'repeat';
            previewContainer.style.backgroundSize = '250px 250px';
            previewModal.classList.add('show');
        });
        
        exportBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'seamless-pattern-' + Date.now() + '.png';
            link.href = canvas.toDataURL();
            link.click();
        });
        
        closeModalBtn.addEventListener('click', () => {
            previewModal.classList.remove('show');
        });

        downloadToolBtn.addEventListener('click', () => {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'seamless-pattern-creator.html';
            link.click();
            URL.revokeObjectURL(link.href);
        });

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'z') {
                    e.preventDefault();
                    e.shiftKey ? redo() : undo();
                } else if (e.key === 'y') {
                    e.preventDefault();
                    redo();
                } else if (e.key === 'd') {
                    e.preventDefault();
                    if (selectedShape) duplicateBtn.click();
                }
            }
            
            if ((e.key === 'Delete' || e.key === 'Backspace') && selectedShape) {
                e.preventDefault();
                deleteBtn.click();
            }
            
            if (!e.ctrlKey && !e.metaKey) {
                if (e.key === 'v' || e.key === 'V') { activeTool = 'select'; updateCanvasHint(); }
                if (e.key === 'c' || e.key === 'C') { activeTool = 'circle'; updateCanvasHint(); }
                if (e.key === 's' || e.key === 'S') { activeTool = 'square'; updateCanvasHint(); }
                if (e.key === 't' || e.key === 'T') { activeTool = 'triangle'; updateCanvasHint(); }
                if (e.key === 'r' || e.key === 'R') { activeTool = 'star'; updateCanvasHint(); }
                if (e.key === 'h' || e.key === 'H') { activeTool = 'hexagon'; updateCanvasHint(); }
                if (e.key === 'p' || e.key === 'P') { activeTool = 'pentagon'; updateCanvasHint(); }
                if (e.key === 'u' || e.key === 'U') { imageUpload.click(); }
            }
            
            if (selectedShape && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
                const amt = e.shiftKey ? 10 : 1;
                if (e.key === 'ArrowUp') selectedShape.y = (selectedShape.y - amt + canvas.height) % canvas.height;
                if (e.key === 'ArrowDown') selectedShape.y = (selectedShape.y + amt) % canvas.height;
                if (e.key === 'ArrowLeft') selectedShape.x = (selectedShape.x - amt + canvas.width) % canvas.width;
                if (e.key === 'ArrowRight') selectedShape.x = (selectedShape.x + amt) % canvas.width;
                saveToHistory();
            }
        });

        function updateSelectionUI() {
            if (selectedShape) {
                selectionControls.classList.remove('hidden');
                selectionPlaceholder.classList.add('hidden');
                const typeNames = {
                    'circle': 'Circle',
                    'square': 'Square',
                    'triangle': 'Triangle',
                    'star': 'Star',
                    'hexagon': 'Hexagon',
                    'pentagon': 'Pentagon',
                    'image': 'Image'
                };
                shapeTypeBadge.textContent = typeNames[selectedShape.type] || 'Shape';
                colorPicker.value = selectedShape.color;
                const size = selectedShape.type === 'circle' ? selectedShape.radius * 2 : (selectedShape.size || 80);
                sizeSlider.value = size;
                sizeValue.textContent = size;
                const opacity = Math.round((selectedShape.opacity || 1) * 100);
                opacitySlider.value = opacity;
                opacityValue.textContent = opacity;
                const rotation = selectedShape.rotation || 0;
                rotationSlider.value = rotation;
                rotationValue.textContent = rotation;
            } else {
                selectionControls.classList.add('hidden');
                selectionPlaceholder.classList.remove('hidden');
            }
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function getShapeAt(x, y) {
            for (let i = shapes.length - 1; i >= 0; i--) {
                const s = shapes[i];
                for (let j = -1; j <= 1; j++) {
                    for (let k = -1; k <= 1; k++) {
                        const cx = s.x + j * canvas.width;
                        const cy = s.y + k * canvas.height;
                        
                        const rot = -(s.rotation || 0) * Math.PI / 180;
                        const dx = x - cx;
                        const dy = y - cy;
                        const lx = dx * Math.cos(rot) - dy * Math.sin(rot);
                        const ly = dx * Math.sin(rot) + dy * Math.cos(rot);
                        
                        let hit = false;
                        if (s.type === 'circle') {
                            hit = lx*lx + ly*ly < s.radius*s.radius;
                        } else if (s.type === 'square') {
                            hit = Math.abs(lx) < s.size/2 && Math.abs(ly) < s.size/2;
                        } else if (s.type === 'triangle') {
                            const h = s.size * (Math.sqrt(3)/2);
                            const v0x = 0, v0y = -h/2;
                            const v1x = -s.size/2, v1y = h/2;
                            const v2x = s.size/2, v2y = h/2;
                            
                            const denom = ((v1y - v2y)*(v0x - v2x) + (v2x - v1x)*(v0y - v2y));
                            const a = ((v1y - v2y)*(lx - v2x) + (v2x - v1x)*(ly - v2y)) / denom;
                            const b = ((v2y - v0y)*(lx - v2x) + (v0x - v2x)*(ly - v2y)) / denom;
                            const c = 1 - a - b;
                            
                            hit = a >= 0 && b >= 0 && c >= 0;
                        } else {
                            const r = (s.size || 80) / 2;
                            hit = lx*lx + ly*ly < r*r;
                        }
                        if (hit) return s;
                    }
                }
            }
            return null;
        }

        requestAnimationFrame(draw);
    </script>
</body>
</html>