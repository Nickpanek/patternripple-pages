<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PatternRipple Slide Puzzle - Daily Online Edition</title>
  <meta name="description" content="Play the PatternRipple Slide Puzzle online. Themes rotate daily using server time. Solve and view designs on Spoonflower." />
  <link rel="canonical" href="https://www.patternripple.com/pattern-slide-puzzle/" />
  <meta property="og:type" content="game" />
  <meta property="og:title" content="PatternRipple Slide Puzzle" />
  <meta property="og:description" content="Daily online puzzles using PatternRipple designs." />
  <meta property="og:image" content="https://www.patternripple.com/pattern-slide-puzzle/preview.jpg" />
  <style>
    :root { --ui:#111; --bg:#f7f7f7; --card:#fff; --muted:#777; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--ui); font:16px system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .wrap { max-width:960px; margin:20px auto; padding:16px; }
    header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    select,button { font:inherit; padding:8px 10px; border:1px solid #ccc; border-radius:8px; background:#fff; cursor:pointer; }
    button.primary { background:#111; color:#fff; border-color:#111; }
    .stats { display:flex; gap:12px; color:var(--muted); }
    .spacer { flex:1; }
    .board-wrap { display:grid; place-items:center; margin-top:16px; }
    .board { width:min(92vw,600px); aspect-ratio:1; background:var(--card); border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); padding:10px; }
    .grid { width:100%; height:100%; display:grid; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr); gap:6px; }
    .tile { position:relative; border-radius:8px; background-size:300% 300%; background-repeat:no-repeat; box-shadow:inset 0 0 0 1px rgba(0,0,0,.12); transition:transform .08s; }
    .tile:active { transform:scale(.98); }
    .tile.empty { background:repeating-conic-gradient(#eee 0 25%,#fafafa 0 50%) 50%/16px 16px; box-shadow:inset 0 0 0 1px rgba(0,0,0,.06); }
    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .muted { color:var(--muted); font-size:14px; }
    dialog { border:none; border-radius:12px; padding:18px; max-width:420px; box-shadow:0 10px 40px rgba(0,0,0,.2); }
    dialog::backdrop { background:rgba(0,0,0,.4); }
    .row { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    a.cta { display:inline-block; padding:10px 12px; border-radius:8px; background:#111; color:#fff; text-decoration:none; }
    .foot { margin-top:14px; font-size:13px; color:var(--muted); }
    #audioToggle { padding:8px 10px; border:1px solid #ccc; border-radius:8px; background:#fff; cursor:pointer; }
    #audioToggle[aria-pressed="true"] { background:#111; color:#fff; border-color:#111; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <strong>Pattern Slide Puzzle</strong>

    <div class="controls">
      <label class="muted">Theme
        <select id="setSelect" aria-label="Theme"></select>
      </label>
      <label class="muted">Pattern
        <select id="patternSelect" aria-label="Pattern"></select>
      </label>
      <button id="shuffle" class="primary">New puzzle</button>
    </div>

    <div class="spacer"></div>

    <div class="controls">
      <button id="audioToggle" aria-pressed="false" aria-label="Toggle music">Music: Off</button>
      <input id="audioVol" type="range" min="0" max="1" step="0.01" value="0.6" aria-label="Music volume" style="width:120px" />
      <a id="audioBuy" class="muted" target="_blank" rel="noopener" style="text-decoration:underline; display:none;">Buy track</a>
    </div>

    <div class="stats">
      <div id="moves">Moves: 0</div>
      <div id="time">Time: 0s</div>
    </div>
  </header>

  <div class="board-wrap">
    <div class="board">
      <div id="grid" class="grid" aria-label="3 by 3 sliding puzzle"></div>
    </div>
    <div class="foot">
      Finish to reveal the Spoonflower link for this design. Daily theme uses server time. Switch sets anytime.
    </div>
  </div>
</div>

<dialog id="win">
  <h3 id="winTitle">Solved</h3>
  <p id="winMsg" class="muted">Stats will show here.</p>
  <div class="row">
    <a id="buy" class="cta" target="_blank" rel="noopener">View on Spoonflower</a>
    <button id="again">Play again</button>
  </div>
</dialog>

<script>
  // Config
  const THEMES = [
    { id:"faux-embroidery", title:"Faux Embroidery" },
    { id:"impasto-floral",  title:"Impasto Floral" },
    { id:"midcentury",      title:"Mid Century" },
    { id:"geometric",       title:"Geometric" },
    { id:"ufo-retro",       title:"UFO Retro" },
    { id:"tropical",        title:"Tropical" },
    { id:"minimal",         title:"Minimal" },
    { id:"maximalist",      title:"Maximalist" }
  ];

  const gridEl = document.getElementById("grid");
  const setSelect = document.getElementById("setSelect");
  const selEl = document.getElementById("patternSelect");
  const movesEl = document.getElementById("moves");
  const timeEl = document.getElementById("time");
  const shuffleBtn = document.getElementById("shuffle");
  const dlg = document.getElementById("win");
  const buy = document.getElementById("buy");
  const winTitle = document.getElementById("winTitle");
  const winMsg = document.getElementById("winMsg");
  const again = document.getElementById("again");

  // Audio globals
  let AUDIO_META = null;
  let audioEl = null;
  let audioReady = false;
  let userInteracted = false;

  // Game state
  let DESIGNS = [];
  let state = [];
  let moves = 0;
  let t0 = 0;
  let timerId = null;
  let current = null;

  // Boot
  buildGrid();
  buildThemeSelector();
  autoSelectTodayTheme();

  // UI builders
  function buildGrid() {
    gridEl.innerHTML = "";
    for (let i = 0; i < 9; i++) {
      const tile = document.createElement("button");
      tile.className = "tile";
      tile.setAttribute("data-idx", i);
      tile.setAttribute("aria-label", "tile");
      tile.addEventListener("click", onTile);
      tile.addEventListener("touchend", onTile, { passive: true });
      gridEl.appendChild(tile);
    }
  }

  function buildThemeSelector() {
    setSelect.innerHTML = "";
    THEMES.forEach((t) => {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.title;
      setSelect.appendChild(opt);
    });
    setSelect.onchange = async () => {
      const id = setSelect.value;
      await loadTheme(id);
      await setThemeAudio(id);
      initPuzzleWithDesigns(DESIGNS);
      localStorage.setItem("puzzleThemeId", id);
    };
  }

  function buildPatternSelector() {
    selEl.innerHTML = "";
    DESIGNS.forEach((d) => {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.title;
      selEl.appendChild(opt);
    });
    selEl.onchange = () => {
      const id = selEl.value;
      current = DESIGNS.find(d => d.id === id) || DESIGNS[0];
      localStorage.setItem("puzzleDesignId", id);
      applyDesign(current);
      newGame();
    };
  }

  // Online daily rotation
  async function getServerISODate() {
    try {
      const r = await fetch('/api/now', { cache: 'no-store' });
      const j = await r.json();
      return j.date;
    } catch {
      return new Date().toISOString().slice(0,10);
    }
  }
  function hashStrToIndex(s, mod) {
    let h = 2166136261;
    for (let i = 0; i < s.length; i++) { h ^= s.charCodeAt(i); h = Math.imul(h,16777619); }
    return (h >>> 0) % mod;
  }

  async function autoSelectTodayTheme() {
    const iso = await getServerISODate();
    const savedTheme = localStorage.getItem("puzzleThemeId");
    const idx = typeof savedTheme === "string"
      ? Math.max(0, THEMES.findIndex(t => t.id === savedTheme))
      : hashStrToIndex(iso, THEMES.length);
    const theme = THEMES[idx] || THEMES[0];
    setSelect.value = theme.id;
    await loadTheme(theme.id);
    await setThemeAudio(theme.id);
    initPuzzleWithDesigns(DESIGNS);
  }

  async function loadTheme(themeId) {
    try {
      const res = await fetch(`collections/${themeId}.json`, { cache:"no-store" });
      DESIGNS = await res.json();
    } catch (e) {
      DESIGNS = [
        { id:"fallback-1", title:"Fallback Pattern 1", img:"img/rose-grid.jpg",
          url:"https://www.spoonflower.com/?utm_source=patternripple&utm_medium=slide-puzzle&utm_campaign=fallback" }
      ];
    }
  }

  async function loadAudioMeta(themeId) {
    try {
      const r = await fetch(`collections/audio.json`, { cache: 'no-store' });
      const all = await r.json();
      return all[themeId] || null;
    } catch { return null; }
  }

  async function setThemeAudio(themeId) {
    AUDIO_META = await loadAudioMeta(themeId);
    const buyLink = document.getElementById('audioBuy');
    if (!audioEl) {
      audioEl = new Audio();
      audioEl.loop = true;
      audioEl.preload = 'auto';
      const vol = parseFloat(document.getElementById('audioVol').value || '0.6');
      audioEl.volume = isNaN(vol) ? 0.6 : vol;
      audioEl.addEventListener('error', ()=>{});
    }
    if (AUDIO_META && AUDIO_META.src) {
      const dailyBust = Date.now() - (Date.now() % 86400000);
      audioEl.src = AUDIO_META.src + `?v=${dailyBust}`;
      if (AUDIO_META.buy) {
        buyLink.href = AUDIO_META.buy;
        buyLink.style.display = 'inline';
      } else {
        buyLink.style.display = 'none';
      }
    } else {
      audioEl.removeAttribute('src');
      buyLink.style.display = 'none';
    }
    audioReady = !!audioEl.src;
  }

  function initPuzzleWithDesigns(list) {
    DESIGNS = list;
    buildPatternSelector();
    const savedDesign = localStorage.getItem("puzzleDesignId");
    current = (savedDesign && DESIGNS.find(d => d.id === savedDesign)) || DESIGNS[0];
    selEl.value = current.id;
    applyDesign(current);
    newGame();
  }

  // Game core
  function applyDesign(design) {
    const tiles = [...gridEl.children];
    tiles.forEach((tile, i) => {
      const pos = indexToPos(i);
      const dailyBust = Date.now() - (Date.now() % 86400000);
      tile.style.backgroundImage = `url(${design.img}?t=${dailyBust})`;
      tile.style.backgroundSize = "300% 300%";
      tile.style.backgroundPosition = `${pos.x * 50}% ${pos.y * 50}%`;
    });
  }

  async function newGame() {
    const iso = await getServerISODate();
    const rand = mulberry32(hashStrToIndex(iso, 2147483647));
    do {
      state = shuffleSeeded([...Array(9).keys()], rand);
    } while (!isSolvable(state) || isSolved(state));
    moves = 0; movesEl.textContent = "Moves: 0";
    startTimer();
    paint();
  }

  function paint() {
    const tiles = [...gridEl.children];
    for (let gridIndex = 0; gridIndex < 9; gridIndex++) {
      const tileIndex = state[gridIndex];
      const tileEl = tiles[gridIndex];
      if (tileIndex === 8) {
        tileEl.classList.add("empty");
        tileEl.style.backgroundImage = "none";
        tileEl.setAttribute("aria-label", "empty space");
      } else {
        tileEl.classList.remove("empty");
        const dailyBust = Date.now() - (Date.now() % 86400000);
        tileEl.style.backgroundImage = `url(${current.img}?t=${dailyBust})`;
        const pos = indexToPos(tileIndex);
        tileEl.style.backgroundPosition = `${pos.x * 50}% ${pos.y * 50}%`;
        tileEl.setAttribute("aria-label", "tile");
      }
    }
  }

  function onTile(e) {
    const tiles = [...gridEl.children];
    const clickedGridIndex = tiles.indexOf(e.currentTarget);
    const emptyGridIndex = state.indexOf(8);
    if (isNeighbor(clickedGridIndex, emptyGridIndex)) {
      [state[clickedGridIndex], state[emptyGridIndex]] = [state[emptyGridIndex], state[clickedGridIndex]];
      moves++; movesEl.textContent = "Moves: " + moves;
      paint();
      if (isSolved(state)) { stopTimer(); victory(); }
    }
    if ("vibrate" in navigator) navigator.vibrate?.(10);
  }

  // Audio control wiring
  function markUserGesture() { userInteracted = true; }
  async function ensureAudioStart() {
    if (!userInteracted || !audioReady || !audioEl) return;
    try {
      await audioEl.play();
      const tgl = document.getElementById('audioToggle');
      tgl.setAttribute('aria-pressed', 'true');
      tgl.textContent = 'Music: On';
    } catch {}
  }
  document.addEventListener('click', markUserGesture, { once: true });
  shuffleBtn.addEventListener('click', () => { ensureAudioStart(); newGame(); });
  again.addEventListener('click', () => { dlg.close(); newGame(); });
  document.getElementById('audioToggle').addEventListener('click', async (e) => {
    markUserGesture();
    if (!audioEl || !audioReady) return;
    const on = e.currentTarget.getAttribute('aria-pressed') !== 'true';
    e.currentTarget.setAttribute('aria-pressed', on ? 'true' : 'false');
    e.currentTarget.textContent = on ? 'Music: On' : 'Music: Off';
    if (on) { try { await audioEl.play(); } catch {} } else { audioEl.pause(); }
  });
  document.getElementById('audioVol').addEventListener('input', (e) => {
    if (audioEl) audioEl.volume = parseFloat(e.target.value || '0.6');
  });

  function startTimer() {
    t0 = Date.now();
    clearInterval(timerId);
    timerId = setInterval(() => {
      const s = Math.floor((Date.now() - t0) / 1000);
      timeEl.textContent = "Time: " + s + "s";
    }, 250);
  }
  function stopTimer() { clearInterval(timerId); }

  function victory() {
    const s = Math.floor((Date.now() - t0) / 1000);
    winMsg.textContent = `Moves ${moves}, time ${s}s`;
    buy.href = current.url;
    dlg.showModal();
    if (AUDIO_META && AUDIO_META.buy) { winTitle.textContent = 'Solved - Enjoy the soundtrack'; }
    if (window.gtag) gtag("event","puzzle_complete",{ theme:setSelect.value, design:current.id, moves:moves, seconds:s });
  }

  // Helpers
  function indexToPos(i){ return { x: i % 3, y: Math.floor(i / 3) }; }
  function isNeighbor(a,b){ const ax=a%3, ay=Math.floor(a/3), bx=b%3, by=Math.floor(b/3); return Math.abs(ax-bx)+Math.abs(ay-by)===1; }
  function isSolved(arr){ for(let i=0;i<9;i++) if(arr[i]!==i) return false; return true; }
  function shuffleSeeded(arr, rand){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rand()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function mulberry32(seed){ return function(){ let t=seed+=0x6D2B79F5; t=Math.imul(t ^ t>>>15, t|1); t^=t+Math.imul(t ^ t>>>7, t|61); return ((t ^ t>>>14)>>>0)/4294967296; }; }
  function isSolvable(arr){ let inv=0; for(let i=0;i<9;i++){ for(let j=i+1;j<9;j++){ if(arr[i]===8||arr[j]===8) continue; if(arr[i]>arr[j]) inv++; } } return inv%2===0; }
</script>

<!-- Ensure no service worker remains -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
  }
</script>
</body>
</html>
