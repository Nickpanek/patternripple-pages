<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PatternRipple | Colorway Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Playfair+Display:wght@700&display=swap');
        :root { --bg:#0e0e0e; --surface:#1a1a1a; --border:#2a2a2a; --accent:#c8f065; --text:#e8e8e8; --muted:#666; }
        * { box-sizing:border-box; margin:0; padding:0; }
        body { font-family:'DM Mono',monospace; background:var(--bg); color:var(--text); min-height:100vh; padding:40px 20px; }
        .app { max-width:620px; margin:0 auto; }
        h1 { font-family:'Playfair Display',serif; font-size:2rem; color:var(--accent); letter-spacing:-1px; margin-bottom:4px; }
        .subtitle { color:var(--muted); font-size:0.75rem; margin-bottom:28px; }
        .upload-zone {
            border:1px dashed var(--border); border-radius:4px; padding:36px;
            text-align:center; cursor:pointer; transition:border-color 0.2s,background 0.2s;
            margin-bottom:22px; position:relative;
        }
        .upload-zone:hover,.upload-zone.dragover { border-color:var(--accent); background:rgba(200,240,101,0.03); }
        .upload-zone input { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
        .upload-label { font-size:0.82rem; color:var(--muted); }
        .upload-label span { color:var(--accent); }
        #preview-wrap { display:none; margin-bottom:22px; }
        #preview-img { max-width:100%; max-height:200px; border:1px solid var(--border); border-radius:4px; display:block; }
        .section-label { font-size:0.68rem; color:var(--muted); text-transform:uppercase; letter-spacing:2px; margin-bottom:12px; }
        .color-grid { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:24px; }
        .color-option { cursor:pointer; }
        .color-option input[type=checkbox] { display:none; }
        .chip-wrap {
            display:flex; flex-direction:column; align-items:center; gap:6px;
            padding:10px 14px; background:var(--surface); border:1px solid var(--border);
            border-radius:4px; transition:border-color 0.15s;
        }
        .color-option input:checked ~ .chip-wrap {
            border-color:var(--accent);
        }
        .color-chip {
            width:32px; height:32px; border-radius:50%;
            border:2px solid rgba(255,255,255,0.08);
            transition:transform 0.15s;
        }
        .color-option input:checked ~ .chip-wrap .color-chip { transform:scale(1.15); }
        .color-name { font-size:0.7rem; color:var(--muted); }
        .color-option input:checked ~ .chip-wrap .color-name { color:var(--accent); }
        .generate-btn {
            width:100%; padding:15px; background:var(--accent); color:#0e0e0e;
            border:none; border-radius:4px; font-family:'DM Mono',monospace;
            font-size:0.88rem; font-weight:500; cursor:pointer; transition:opacity 0.2s; letter-spacing:1px;
        }
        .generate-btn:hover { opacity:0.88; }
        .generate-btn:disabled { opacity:0.3; cursor:not-allowed; }
        .progress-bar { width:100%; height:2px; background:var(--border); border-radius:2px; margin-top:12px; overflow:hidden; display:none; }
        .progress-fill { height:100%; background:var(--accent); width:0%; transition:width 0.2s; }
        #status { margin-top:10px; font-size:0.74rem; color:var(--muted); text-align:center; min-height:18px; }
    </style>
</head>
<body>
<div class="app">
    <h1>Colorway Generator</h1>
    <div class="subtitle">one output per checked color â€” preserves light/dark structure</div>
    <div class="upload-zone" id="dropZone">
        <input type="file" id="imageInput" accept="image/png,image/jpeg">
        <div class="upload-label">Drop pattern here or <span>browse</span></div>
    </div>
    <div id="preview-wrap">
        <div class="section-label">Preview</div>
        <img id="preview-img" alt="preview">
    </div>
    <div class="section-label">Pick colorways</div>
    <div class="color-grid">
        <label class="color-option"><input type="checkbox" value="0,80"><div class="chip-wrap"><div class="color-chip" style="background:#e63946"></div><span class="color-name">Red</span></div></label>
        <label class="color-option"><input type="checkbox" value="215,215"><div class="chip-wrap"><div class="color-chip" style="background:#4578db"></div><span class="color-name">Blue</span></div></label>
        <label class="color-option"><input type="checkbox" value="52,52"><div class="chip-wrap"><div class="color-chip" style="background:#f4c430"></div><span class="color-name">Yellow</span></div></label>
        <label class="color-option"><input type="checkbox" value="25,25"><div class="chip-wrap"><div class="color-chip" style="background:#e07b30"></div><span class="color-name">Orange</span></div></label>
        <label class="color-option"><input type="checkbox" value="130,130"><div class="chip-wrap"><div class="color-chip" style="background:#3a9c4e"></div><span class="color-name">Green</span></div></label>
        <label class="color-option"><input type="checkbox" value="280,280"><div class="chip-wrap"><div class="color-chip" style="background:#7b52ab"></div><span class="color-name">Purple</span></div></label>
        <label class="color-option"><input type="checkbox" value="180,180"><div class="chip-wrap"><div class="color-chip" style="background:#2ab7ca"></div><span class="color-name">Teal</span></div></label>
        <label class="color-option"><input type="checkbox" value="330,330"><div class="chip-wrap"><div class="color-chip" style="background:#e05c8a"></div><span class="color-name">Pink</span></div></label>
    </div>
    <button class="generate-btn" id="generateBtn" disabled>Generate & Download ZIP</button>
    <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
    <div id="status"></div>
</div>
<canvas id="canvas" style="display:none;"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let originalImageData = null;
const dropZone = document.getElementById('dropZone');
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); if(e.dataTransfer.files[0]) loadImage(e.dataTransfer.files[0]); });
document.getElementById('imageInput').addEventListener('change', e => { if(e.target.files[0]) loadImage(e.target.files[0]); });
function loadImage(file) {
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
        canvas.width = img.width; canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        document.getElementById('preview-img').src = url;
        document.getElementById('preview-wrap').style.display = 'block';
        document.getElementById('generateBtn').disabled = false;
    };
    img.src = url;
}
function rgbToHsl(r,g,b) {
    r/=255; g/=255; b/=255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b);
    let h,s,l=(max+min)/2;
    if(max===min){h=s=0;}
    else{
        const d=max-min;
        s=l>0.5?d/(2-max-min):d/(max+min);
        switch(max){
            case r:h=((g-b)/d+(g<b?6:0))/6;break;
            case g:h=((b-r)/d+2)/6;break;
            case b:h=((r-g)/d+4)/6;break;
        }
    }
    return [h*360,s,l];
}
function hslToRgb(h,s,l) {
    h/=360;
    if(s===0){const v=Math.round(l*255);return[v,v,v];}
    const q=l<0.5?l*(1+s):l+s-l*s, p=2*l-q;
    const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};
    return[Math.round(hue2rgb(p,q,h+1/3)*255),Math.round(hue2rgb(p,q,h)*255),Math.round(hue2rgb(p,q,h-1/3)*255)];
}
document.getElementById('generateBtn').addEventListener('click', async () => {
    const selected = [...document.querySelectorAll('input[type=checkbox]:checked')];
    if(!selected.length){ document.getElementById('status').textContent='Check at least one color.'; return; }
    const btn=document.getElementById('generateBtn');
    const fill=document.getElementById('progressFill');
    const status=document.getElementById('status');
    btn.disabled=true;
    document.getElementById('progressBar').style.display='block';
    fill.style.width='0%';
    const zip=new JSZip();
    for(let i=0;i<selected.length;i++){
        const el=selected[i];
        const [hueLight, hueDark]=el.value.split(',').map(Number);
        const name=el.closest('label').querySelector('.color-name').textContent;
        status.textContent=`Processing ${name} (${i+1}/${selected.length})...`;
        const nd=new ImageData(new Uint8ClampedArray(originalImageData.data),originalImageData.width,originalImageData.height);
        const d=nd.data;
        for(let j=0;j<d.length;j+=4){
            if(d[j+3]<10) continue;
            const [h,s,l]=rgbToHsl(d[j],d[j+1],d[j+2]);
            if(s<0.06) continue; // leave grays/whites/blacks alone
            // all colored pixels shift to the target hue, keeping their lightness & saturation
            const targetHue=hueLight*l+hueDark*(1-l);
            const [nr,ng,nb]=hslToRgb(targetHue,s,l);
            d[j]=nr;d[j+1]=ng;d[j+2]=nb;
        }
        ctx.putImageData(nd,0,0);
        const b64=canvas.toDataURL('image/png').split(',')[1];
        zip.file(`colorway_${name}.png`,b64,{base64:true});
        fill.style.width=`${((i+1)/selected.length)*100}%`;
        await new Promise(r=>setTimeout(r,10));
    }
    status.textContent='Zipping...';
    const blob=await zip.generateAsync({type:'blob'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='PatternRipple_Colorways.zip';
    a.click();
    status.textContent=`Done. ${selected.length} colorway(s) downloaded.`;
    btn.disabled=false;
});
</script>
</body>
</html>
