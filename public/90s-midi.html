<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° RADWAVE MIDI SYNTH 95 ‚ö°</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');
        
        * { box-sizing: border-box; }
        
        body { 
            background: linear-gradient(135deg, #1a0033 0%, #0d001a 25%, #330033 50%, #0d001a 75%, #1a0033 100%);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            color: #00ff00;
            font-family: 'VT323', monospace;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.4; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes rainbow {
            to { background-position: 200% center; }
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 0, 0.15);
            animation: scanline 10s linear infinite;
            pointer-events: none;
            z-index: 9999;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 10px;
        }

        /* Window styling */
        .window {
            background: rgba(0, 0, 0, 0.85);
            border: 3px solid;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        .window-cyan { border-color: #00ffff; }
        .window-magenta { border-color: #ff00ff; }
        .window-yellow { border-color: #ffff00; }
        .window-green { border-color: #00ff00; }

        .window-header {
            background: linear-gradient(90deg, #ff00ff, #00ffff, #ffff00, #00ffff, #ff00ff);
            background-size: 200% auto;
            animation: rainbow 4s linear infinite;
            padding: 8px 12px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.75rem;
            color: #000;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            border-bottom: 2px solid #00ff00;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .window-body {
            padding: 12px;
        }

        /* Button styles */
        .btn {
            padding: 8px 16px;
            border: 3px solid;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 900;
            font-family: 'VT323', monospace;
            transition: all 0.15s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.8);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-cyan {
            background: linear-gradient(135deg, #0088ff, #00ffff);
            border-color: #00ffff;
            color: #000;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
        }

        .btn-magenta {
            background: linear-gradient(135deg, #ff00ff, #ff0088);
            border-color: #ff00ff;
            color: #000;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.6);
        }

        .btn-green {
            background: linear-gradient(135deg, #00ff00, #00cc00);
            border-color: #00ff00;
            color: #000;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
        }

        .btn-yellow {
            background: linear-gradient(135deg, #ffff00, #ffcc00);
            border-color: #ffff00;
            color: #000;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.6);
        }

        .btn-red {
            background: linear-gradient(135deg, #ff0066, #ff0000);
            border-color: #ff00ff;
            color: #fff;
            box-shadow: 0 0 15px rgba(255, 0, 100, 0.6);
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(80%);
        }

        /* Visualizer */
        #visualizer-canvas {
            width: 100%;
            height: 100%;
            display: block;
            background: #000;
        }

        /* Piano keyboard */
        .piano-container {
            height: 120px;
            position: relative;
            background: #000;
        }

        .piano-key {
            position: absolute;
            bottom: 0;
            cursor: pointer;
            transition: all 0.05s;
        }

        .piano-key.white {
            background: linear-gradient(to bottom, #fff 0%, #e0e0e0 100%);
            border: 2px solid #000;
            border-radius: 0 0 4px 4px;
            height: 100%;
        }

        .piano-key.black {
            background: linear-gradient(to bottom, #333 0%, #000 100%);
            border: 2px solid #000;
            border-radius: 0 0 3px 3px;
            height: 65%;
            z-index: 10;
        }

        .piano-key.active.white {
            background: linear-gradient(to bottom, #00ff00 0%, #00cc00 100%);
            box-shadow: 0 0 20px #00ff00;
        }

        .piano-key.active.black {
            background: linear-gradient(to bottom, #ff00ff 0%, #cc00cc 100%);
            box-shadow: 0 0 20px #ff00ff;
        }

        /* Channel meters */
        .channel-meters {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            height: 100%;
        }

        .channel-meter {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00ffff;
            border-radius: 4px;
            padding: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .channel-label {
            font-size: 0.7rem;
            color: #00ffff;
            text-shadow: 0 0 5px #00ffff;
        }

        .meter-bar {
            flex: 1;
            width: 100%;
            background: rgba(0, 50, 50, 0.5);
            border: 1px solid #006666;
            border-radius: 2px;
            position: relative;
            overflow: hidden;
        }

        .meter-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, #00ff00, #ffff00, #ff0000);
            transition: height 0.1s;
            height: 0%;
        }

        /* Playlist */
        .playlist {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00ffff;
            border-radius: 4px;
        }

        .playlist-item {
            padding: 8px 12px;
            border-bottom: 1px solid #003333;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .playlist-item:hover {
            background: rgba(0, 255, 255, 0.2);
        }

        .playlist-item.active {
            background: rgba(0, 255, 0, 0.3);
            color: #00ff00;
            font-weight: bold;
        }

        /* Progress bar */
        .progress-container {
            width: 100%;
            height: 30px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #ff00ff;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00ffff, #ff00ff);
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .progress-time {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9rem;
            color: #fff;
            text-shadow: 0 0 5px #000, 0 0 10px #000;
            pointer-events: none;
        }

        /* Slider */
        input[type="range"] {
            width: 100%;
            height: 30px;
            -webkit-appearance: none;
            background: transparent;
        }

        input[type="range"]::-webkit-slider-track {
            height: 10px;
            background: linear-gradient(90deg, #000, #333);
            border: 2px solid #00ffff;
            border-radius: 5px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ff00ff, #00ffff);
            border: 2px solid #ffff00;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.8);
        }

        input[type="range"]::-moz-range-track {
            height: 10px;
            background: linear-gradient(90deg, #000, #333);
            border: 2px solid #00ffff;
            border-radius: 5px;
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ff00ff, #00ffff);
            border: 2px solid #ffff00;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.8);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ffff;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ff00ff, #00ffff);
            border: 1px solid #000;
            border-radius: 6px;
        }

        /* Info display */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .info-box {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #ffff00;
            border-radius: 4px;
            padding: 8px;
            text-align: center;
        }

        .info-label {
            font-size: 0.8rem;
            color: #ffff00;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 1.2rem;
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }

        /* Lyrics display */
        .lyrics-display {
            height: 80px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #ff00ff;
            border-radius: 4px;
            padding: 10px;
            font-size: 1.3rem;
            color: #00ffff;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 0 10px #00ffff;
            overflow: hidden;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="scanline"></div>
    
    <div class="container">
        <!-- Top bar -->
        <div class="window window-cyan" style="flex-shrink: 0;">
            <div class="window-header">
                <span>‚ö° RADWAVE MIDI SYNTH 95 ‚ö°</span>
                <span style="font-size: 0.6rem;">v1.0.0</span>
            </div>
            <div class="window-body">
                <div class="flex gap-3 items-center justify-between flex-wrap">
                    <div class="flex gap-2">
                        <label class="btn btn-cyan">
                            <input type="file" id="midi-upload" accept=".mid,.midi" multiple style="display:none">
                            üìÇ ADD MIDI
                        </label>
                        <button id="btn-play" class="btn btn-green">‚ñ∂ PLAY</button>
                        <button id="btn-pause" class="btn btn-yellow">‚è∏ PAUSE</button>
                        <button id="btn-stop" class="btn btn-red">‚èπ STOP</button>
                    </div>
                    
                    <div class="flex gap-2 items-center">
                        <span style="color: #00ffff;">VOLUME:</span>
                        <input type="range" id="volume-slider" min="0" max="100" value="80" style="width: 150px;">
                        <span id="volume-display" style="color: #00ff00; min-width: 40px;">80%</span>
                    </div>

                    <div class="flex gap-2">
                        <button id="btn-prev" class="btn btn-magenta">‚èÆ PREV</button>
                        <button id="btn-next" class="btn btn-magenta">‚è≠ NEXT</button>
                    </div>
                </div>

                <!-- Progress bar -->
                <div class="progress-container mt-3" id="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                    <div class="progress-time" id="progress-time">0:00 / 0:00</div>
                </div>
            </div>
        </div>

        <!-- Main content area -->
        <div class="grid-3" style="flex: 1; min-height: 0;">
            <!-- Left column -->
            <div style="display: flex; flex-direction: column; gap: 10px; min-height: 0;">
                <!-- Visualizer -->
                <div class="window window-magenta" style="flex: 1; min-height: 0;">
                    <div class="window-header">üåä WAVEFORM VISUALIZER</div>
                    <div class="window-body" style="padding: 0; height: calc(100% - 40px);">
                        <canvas id="visualizer-canvas"></canvas>
                    </div>
                </div>

                <!-- Piano keyboard -->
                <div class="window window-green" style="flex-shrink: 0;">
                    <div class="window-header">üéπ VIRTUAL KEYBOARD</div>
                    <div class="window-body" style="padding: 0;">
                        <div class="piano-container" id="piano-container"></div>
                    </div>
                </div>
            </div>

            <!-- Right column -->
            <div style="display: flex; flex-direction: column; gap: 10px; min-height: 0;">
                <!-- Info panel -->
                <div class="window window-yellow" style="flex-shrink: 0;">
                    <div class="window-header">üìä TRACK INFO</div>
                    <div class="window-body">
                        <div class="info-grid">
                            <div class="info-box">
                                <div class="info-label">TEMPO</div>
                                <div class="info-value" id="info-tempo">120</div>
                            </div>
                            <div class="info-box">
                                <div class="info-label">TRACKS</div>
                                <div class="info-value" id="info-tracks">0</div>
                            </div>
                            <div class="info-box">
                                <div class="info-label">NOTES</div>
                                <div class="info-value" id="info-notes">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lyrics -->
                <div class="window window-cyan" style="flex-shrink: 0;">
                    <div class="window-header">üé§ LYRICS</div>
                    <div class="window-body" style="padding: 0;">
                        <div class="lyrics-display" id="lyrics-display">
                            ‚ô™ No lyrics available ‚ô™
                        </div>
                    </div>
                </div>

                <!-- Channel meters -->
                <div class="window window-magenta" style="flex: 1; min-height: 0;">
                    <div class="window-header">üéöÔ∏è CHANNEL METERS</div>
                    <div class="window-body" style="height: calc(100% - 40px);">
                        <div class="channel-meters" id="channel-meters"></div>
                    </div>
                </div>

                <!-- Playlist -->
                <div class="window window-green" style="flex: 1; min-height: 0;">
                    <div class="window-header">üìú PLAYLIST</div>
                    <div class="window-body" style="padding: 0; height: calc(100% - 40px); overflow: hidden;">
                        <div class="playlist" id="playlist">
                            <div style="padding: 20px; text-align: center; color: #666;">
                                No files loaded. Click "ADD MIDI" to begin.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // STATE MANAGEMENT
        // ============================================================================
        const state = {
            midiFiles: [],
            currentIndex: 0,
            isPlaying: false,
            isPaused: false,
            currentSynth: null,
            scheduledNotes: [],
            activeNotes: new Set(),
            startTime: 0,
            pauseTime: 0,
            currentTime: 0,
            duration: 0,
            animationFrame: null,
            channelVolumes: new Array(16).fill(0),
            tempo: 120,
            lyrics: [],
            currentLyric: '',
        };

        // ============================================================================
        // MIDI PARSING
        // ============================================================================
        async function parseMIDIFile(file) {
            // Simple MIDI parser - extracts note events
            const buffer = await file.arrayBuffer();
            const view = new DataView(buffer);
            
            // Basic MIDI file validation
            const header = String.fromCharCode(view.getUint8(0), view.getUint8(1), view.getUint8(2), view.getUint8(3));
            if (header !== 'MThd') {
                throw new Error('Invalid MIDI file');
            }

            // For simplicity, we'll use a basic note extraction
            // In production, you'd want a full MIDI parser library
            const notes = [];
            const lyrics = [];
            let tempo = 500000; // Default tempo (120 BPM)
            
            // Scan for note events (simplified)
            for (let i = 0; i < view.byteLength - 3; i++) {
                const status = view.getUint8(i);
                
                // Note On (0x90-0x9F)
                if ((status & 0xF0) === 0x90) {
                    const channel = status & 0x0F;
                    const note = view.getUint8(i + 1);
                    const velocity = view.getUint8(i + 2);
                    
                    if (velocity > 0 && note >= 21 && note <= 108) {
                        notes.push({
                            type: 'noteOn',
                            note: note,
                            channel: channel,
                            velocity: velocity / 127,
                            time: i / 1000 // Approximate timing
                        });
                    }
                }
            }

            const bpm = Math.round(60000000 / tempo);
            
            return {
                name: file.name,
                notes: notes,
                lyrics: lyrics,
                tempo: bpm,
                duration: notes.length > 0 ? notes[notes.length - 1].time + 2 : 0
            };
        }

        // ============================================================================
        // AUDIO SYNTHESIS
        // ============================================================================
        async function initAudio() {
            if (!state.currentSynth) {
                await Tone.start();
                state.currentSynth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "fatsawtooth" },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.5, release: 0.4 }
                }).toDestination();
                state.currentSynth.volume.value = -10;
            }
        }

        function playNote(note, velocity = 0.8, duration = 0.5) {
            if (!state.currentSynth) return;
            
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const noteName = noteNames[note % 12];
            const octave = Math.floor(note / 12) - 1;
            const fullNote = noteName + octave;
            
            try {
                state.currentSynth.triggerAttackRelease(fullNote, duration, undefined, velocity);
                state.activeNotes.add(note);
                
                // Update channel meter (simplified - use note as channel indicator)
                const channel = note % 16;
                state.channelVolumes[channel] = Math.max(state.channelVolumes[channel], velocity);
                
                setTimeout(() => {
                    state.activeNotes.delete(note);
                }, duration * 1000);
            } catch (e) {
                console.warn('Note play error:', e);
            }
        }

        // ============================================================================
        // PLAYBACK CONTROL
        // ============================================================================
        async function play() {
            if (state.midiFiles.length === 0) return;
            
            await initAudio();
            
            const currentFile = state.midiFiles[state.currentIndex];
            if (!currentFile) return;

            state.isPlaying = true;
            state.isPaused = false;
            state.startTime = Tone.now();
            state.duration = currentFile.duration;
            
            updateUI();
            scheduleNotes();
            animate();
        }

        function scheduleNotes() {
            const currentFile = state.midiFiles[state.currentIndex];
            if (!currentFile || !currentFile.notes) return;

            // Schedule notes to play
            currentFile.notes.forEach(noteEvent => {
                const scheduleTime = state.startTime + noteEvent.time;
                state.scheduledNotes.push(
                    setTimeout(() => {
                        if (state.isPlaying && !state.isPaused) {
                            playNote(noteEvent.note, noteEvent.velocity, 0.5);
                        }
                    }, noteEvent.time * 1000)
                );
            });

            // Auto-advance when song ends
            state.scheduledNotes.push(
                setTimeout(() => {
                    if (state.isPlaying) {
                        next();
                    }
                }, currentFile.duration * 1000)
            );
        }

        function pause() {
            if (!state.isPlaying) return;
            
            state.isPaused = !state.isPaused;
            
            if (state.isPaused) {
                state.pauseTime = Tone.now() - state.startTime;
                state.currentSynth?.releaseAll();
            } else {
                state.startTime = Tone.now() - state.pauseTime;
            }
            
            updateUI();
        }

        function stop() {
            state.isPlaying = false;
            state.isPaused = false;
            state.currentTime = 0;
            state.activeNotes.clear();
            
            // Clear scheduled notes
            state.scheduledNotes.forEach(timeout => clearTimeout(timeout));
            state.scheduledNotes = [];
            
            if (state.currentSynth) {
                state.currentSynth.releaseAll();
            }
            
            if (state.animationFrame) {
                cancelAnimationFrame(state.animationFrame);
                state.animationFrame = null;
            }
            
            updateUI();
        }

        function next() {
            stop();
            state.currentIndex = (state.currentIndex + 1) % state.midiFiles.length;
            updatePlaylistUI();
            setTimeout(() => play(), 100);
        }

        function prev() {
            stop();
            state.currentIndex = (state.currentIndex - 1 + state.midiFiles.length) % state.midiFiles.length;
            updatePlaylistUI();
            setTimeout(() => play(), 100);
        }

        // ============================================================================
        // UI RENDERING
        // ============================================================================
        function updateUI() {
            document.getElementById('btn-play').disabled = state.isPlaying && !state.isPaused;
            document.getElementById('btn-pause').disabled = !state.isPlaying;
            document.getElementById('btn-stop').disabled = !state.isPlaying;
            document.getElementById('btn-next').disabled = state.midiFiles.length === 0;
            document.getElementById('btn-prev').disabled = state.midiFiles.length === 0;
        }

        function updateProgress() {
            if (!state.isPlaying || state.isPaused) return;
            
            state.currentTime = Tone.now() - state.startTime;
            const progress = state.duration > 0 ? (state.currentTime / state.duration) * 100 : 0;
            
            document.getElementById('progress-bar').style.width = Math.min(progress, 100) + '%';
            document.getElementById('progress-time').textContent = 
                formatTime(state.currentTime) + ' / ' + formatTime(state.duration);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        function animate() {
            if (!state.isPlaying) return;
            
            updateProgress();
            drawVisualizer();
            updatePiano();
            updateChannelMeters();
            
            state.animationFrame = requestAnimationFrame(animate);
        }

        // ============================================================================
        // VISUALIZER
        // ============================================================================
        const canvas = document.getElementById('visualizer-canvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        function drawVisualizer() {
            const w = canvas.width;
            const h = canvas.height;
            
            // Clear with fade effect
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, w, h);
            
            // Draw active notes as bars
            const noteArray = Array.from(state.activeNotes);
            const barWidth = noteArray.length > 0 ? w / noteArray.length : 0;
            
            noteArray.forEach((note, i) => {
                const x = i * barWidth;
                const hue = (note * 7) % 360;
                const barHeight = (note / 108) * h;
                
                ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                ctx.shadowBlur = 20;
                ctx.shadowColor = `hsl(${hue}, 100%, 50%)`;
                ctx.fillRect(x, h - barHeight, barWidth - 2, barHeight);
            });
            
            ctx.shadowBlur = 0;
            
            // Draw waveform effect
            const time = Date.now() / 1000;
            ctx.strokeStyle = '#00ffff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for (let x = 0; x < w; x += 2) {
                const y = h/2 + Math.sin(x * 0.02 + time * 2) * 20 * (state.activeNotes.size / 10);
                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            
            ctx.stroke();
        }

        // ============================================================================
        // PIANO KEYBOARD
        // ============================================================================
        function createPiano() {
            const container = document.getElementById('piano-container');
            const width = container.clientWidth;
            const whiteKeyWidth = width / 52;
            
            let whiteKeyIndex = 0;
            
            for (let note = 21; note <= 108; note++) {
                const key = document.createElement('div');
                key.className = 'piano-key';
                key.dataset.note = note;
                
                const noteInOctave = note % 12;
                const isBlack = [1, 3, 6, 8, 10].includes(noteInOctave);
                
                if (isBlack) {
                    key.classList.add('black');
                    const prevWhiteX = (whiteKeyIndex - 1) * whiteKeyWidth;
                    key.style.left = (prevWhiteX + whiteKeyWidth - whiteKeyWidth * 0.3) + 'px';
                    key.style.width = (whiteKeyWidth * 0.6) + 'px';
                } else {
                    key.classList.add('white');
                    key.style.left = (whiteKeyIndex * whiteKeyWidth) + 'px';
                    key.style.width = whiteKeyWidth + 'px';
                    whiteKeyIndex++;
                }
                
                key.addEventListener('mousedown', () => playNote(note));
                container.appendChild(key);
            }
        }

        function updatePiano() {
            document.querySelectorAll('.piano-key').forEach(key => {
                const note = parseInt(key.dataset.note);
                if (state.activeNotes.has(note)) {
                    key.classList.add('active');
                } else {
                    key.classList.remove('active');
                }
            });
        }

        // ============================================================================
        // CHANNEL METERS
        // ============================================================================
        function createChannelMeters() {
            const container = document.getElementById('channel-meters');
            container.innerHTML = '';
            
            for (let i = 0; i < 16; i++) {
                const meter = document.createElement('div');
                meter.className = 'channel-meter';
                meter.innerHTML = `
                    <div class="channel-label">CH${i + 1}</div>
                    <div class="meter-bar">
                        <div class="meter-fill" id="meter-${i}"></div>
                    </div>
                `;
                container.appendChild(meter);
            }
        }

        function updateChannelMeters() {
            state.channelVolumes.forEach((volume, i) => {
                const fill = document.getElementById(`meter-${i}`);
                if (fill) {
                    fill.style.height = (volume * 100) + '%';
                }
                // Decay
                state.channelVolumes[i] *= 0.9;
            });
        }

        // ============================================================================
        // PLAYLIST
        // ============================================================================
        function updatePlaylistUI() {
            const playlist = document.getElementById('playlist');
            
            if (state.midiFiles.length === 0) {
                playlist.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        No files loaded. Click "ADD MIDI" to begin.
                    </div>
                `;
                return;
            }
            
            playlist.innerHTML = state.midiFiles.map((file, i) => `
                <div class="playlist-item ${i === state.currentIndex ? 'active' : ''}" data-index="${i}">
                    <span>${file.name}</span>
                    <span style="color: #666;">${formatTime(file.duration)}</span>
                </div>
            `).join('');
            
            // Add click handlers
            playlist.querySelectorAll('.playlist-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    if (index !== state.currentIndex) {
                        stop();
                        state.currentIndex = index;
                        updatePlaylistUI();
                        setTimeout(() => play(), 100);
                    }
                });
            });
        }

        // ============================================================================
        // FILE HANDLING
        // ============================================================================
        document.getElementById('midi-upload').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            
            for (const file of files) {
                try {
                    const parsed = await parseMIDIFile(file);
                    state.midiFiles.push(parsed);
                    
                    // Update info
                    document.getElementById('info-tempo').textContent = parsed.tempo;
                    document.getElementById('info-tracks').textContent = state.midiFiles.length;
                    document.getElementById('info-notes').textContent = parsed.notes.length;
                } catch (err) {
                    console.error('Error parsing MIDI file:', err);
                    alert('Error loading: ' + file.name);
                }
            }
            
            updatePlaylistUI();
            updateUI();
            
            // Auto-play first file
            if (state.midiFiles.length === 1 && !state.isPlaying) {
                setTimeout(() => play(), 500);
            }
        });

        // ============================================================================
        // CONTROLS
        // ============================================================================
        document.getElementById('btn-play').addEventListener('click', play);
        document.getElementById('btn-pause').addEventListener('click', pause);
        document.getElementById('btn-stop').addEventListener('click', stop);
        document.getElementById('btn-next').addEventListener('click', next);
        document.getElementById('btn-prev').addEventListener('click', prev);

        document.getElementById('volume-slider').addEventListener('input', (e) => {
            const volume = parseInt(e.target.value);
            document.getElementById('volume-display').textContent = volume + '%';
            if (state.currentSynth) {
                state.currentSynth.volume.value = (volume / 100) * 20 - 20; // -20 to 0 dB
            }
        });

        document.getElementById('progress-container').addEventListener('click', (e) => {
            if (!state.isPlaying) return;
            
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const percent = x / rect.width;
            
            // Seek (simplified - would need to reschedule notes)
            state.currentTime = percent * state.duration;
            state.startTime = Tone.now() - state.currentTime;
        });

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        createPiano();
        createChannelMeters();
        updateUI();

        // Start animation loop for visuals even when not playing
        function idleAnimate() {
            if (!state.isPlaying) {
                drawVisualizer();
            }
            requestAnimationFrame(idleAnimate);
        }
        idleAnimate();
    </script>
</body>
</html>
