<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° 90s MIDI VISUALIZER ‚ö°</title>
    
    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    
    <!-- Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');
        
        body { 
            background: linear-gradient(135deg, #1a0033 0%, #0d001a 50%, #1a0033 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: #00ff00;
            font-family: 'VT323', monospace;
            overflow: hidden; 
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }

        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 0, 0.1);
            animation: scanline 8s linear infinite;
            pointer-events: none;
            z-index: 9999;
        }
        
        #canvas-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 120px);
            background: #000000;
            border: 4px solid #00ff00;
            box-shadow: 
                inset 0 0 20px rgba(0, 255, 0, 0.3),
                0 0 30px rgba(0, 255, 0, 0.5),
                0 0 60px rgba(255, 0, 255, 0.3);
            border-radius: 8px;
        }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* Header */
        .header {
            background: linear-gradient(90deg, 
                #ff00ff 0%, 
                #00ffff 25%, 
                #ffff00 50%, 
                #00ffff 75%, 
                #ff00ff 100%);
            background-size: 200% auto;
            animation: rainbow 3s linear infinite;
            border: 3px solid #00ff00;
            border-radius: 8px;
            box-shadow: 
                0 0 20px rgba(0, 255, 0, 0.6),
                inset 0 0 20px rgba(255, 255, 255, 0.2);
        }

        @keyframes rainbow {
            to { background-position: 200% center; }
        }
        
        .title-text {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.3rem;
            color: #000000;
            text-shadow: 
                2px 2px 0px #00ff00,
                4px 4px 0px #ff00ff,
                6px 6px 0px #00ffff;
            animation: blink 2s infinite;
            letter-spacing: 2px;
        }

        .subtitle {
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            color: #000000;
            font-weight: bold;
            letter-spacing: 1px;
        }

        #status {
            color: #00ff00;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 8px;
            border-radius: 4px;
            border: 2px solid #00ff00;
        }

        /* UI Components */
        .control-group {
            display: flex; 
            gap: 8px; 
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 14px;
            border-radius: 8px;
            border: 3px solid #ff00ff;
            box-shadow: 
                0 0 15px rgba(255, 0, 255, 0.6),
                inset 0 0 10px rgba(255, 0, 255, 0.2);
        }
        
        .btn {
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 900;
            transition: all 0.1s ease-in-out;
            white-space: nowrap;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 6px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
            border: 3px solid;
            font-family: 'VT323', monospace;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.8);
        }
        .btn:active {
            transform: translateY(1px) scale(0.98);
        }

        .btn-blue { 
            background: linear-gradient(135deg, #0066ff, #00ccff); 
            color: white; 
            border-color: #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
        }
        .btn-blue:hover { 
            background: linear-gradient(135deg, #0088ff, #00eeff);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.9);
        }
        
        .btn-green { 
            background: linear-gradient(135deg, #00ff00, #00cc00); 
            color: #000000; 
            border-color: #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
        }
        .btn-green:hover { 
            background: linear-gradient(135deg, #33ff33, #00ff00);
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.9);
        }
        
        .btn-red { 
            background: linear-gradient(135deg, #ff0066, #ff0000); 
            color: white; 
            border-color: #ff00ff;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.6);
        }
        .btn-red:hover { 
            background: linear-gradient(135deg, #ff0088, #ff3333);
            box-shadow: 0 0 25px rgba(255, 0, 255, 0.9);
        }
        
        .btn-purple { 
            background: linear-gradient(135deg, #ff00ff, #8800ff); 
            color: #00ff00;
            border-color: #ffff00;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.6);
            animation: pulse 2s infinite;
        }
        .btn-purple:hover { 
            background: linear-gradient(135deg, #ff33ff, #aa00ff);
            box-shadow: 0 0 30px rgba(255, 255, 0, 0.9);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 0, 0.6); }
            50% { box-shadow: 0 0 30px rgba(255, 255, 0, 1); }
        }
        
        select {
            background: linear-gradient(135deg, #000000, #330033);
            color: #00ff00;
            border: 3px solid #00ffff;
            border-radius: 6px;
            padding: 6px 10px;
            outline: none; 
            font-size: 1rem; 
            cursor: pointer; 
            width: 100%;
            font-family: 'VT323', monospace;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        select:hover {
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
        }

        select option {
            background: #000000;
            color: #00ff00;
        }

        button:disabled { 
            opacity: 0.3; 
            cursor: not-allowed; 
            filter: grayscale(80%);
            box-shadow: none !important;
        }

    </style>
</head>
<body class="flex flex-col h-screen p-3">
    <div class="scanline"></div>

    <!-- Header / Controls -->
    <div class="header flex items-center justify-between px-5 py-4 z-10 mb-3">
        <div class="flex flex-col justify-center">
            <h1 class="title-text">‚ö° 90s MIDI ‚ö°</h1>
            <div class="subtitle">BY PATTERNRIPPLE</div>
            <div id="status" class="mt-2">‚ñ∫ READY TO JAM ‚óÑ</div>
        </div>
        
        <div class="flex gap-3 items-center flex-wrap">
            
            <div class="control-group w-48">
                <select id="instrument-select" onchange="changeInstrument(this.value)">
                    <option value="piano" selected>üéπ REAL PIANO</option>
                    <option value="drums">ü•Å DRUMS</option>
                    <option value="synth">üåå SYNTHWAVE</option>
                    <option value="lovecraft">üêô LOVECRAFT PAD</option>
                </select>
            </div>

            <div class="flex gap-2 flex-wrap">
                <label class="btn btn-blue">
                    <input type="file" id="midi-upload" accept=".mid,.midi" style="display:none">
                    üìÇ LOAD MIDI
                </label>
                <button id="btn-play" class="btn btn-green">‚ñ∂ PLAY</button>
                <button id="btn-stop" class="btn btn-red">‚èπ STOP</button>
                <button id="btn-download" onclick="downloadWav()" class="btn btn-purple">
                    üíæ SAVE WAV
                </button>
            </div>
        </div>
    </div>

    <!-- Main Visualization Area -->
    <div id="canvas-container">
        <canvas id="visualizer"></canvas>
    </div>

    <!-- PyConfig -->
    <py-config>
        packages = ["mido"]
    </py-config>

    <!-- JS Audio Bridge & WAV Encoder -->
    <script>
        let currentSynth = null; 
        let isAudioInit = false;
        let selectedInstrument = 'piano';

        // --- Instrument Configs ---
        function getInstrumentConfig(type) {
            if (type === 'piano') {
                return {
                    type: 'Sampler',
                    options: {
                        urls: {
                            "C4": "C4.mp3", "D#4": "Ds4.mp3", "F#4": "Fs4.mp3", "A4": "A4.mp3",
                            "C5": "C5.mp3", "D#5": "Ds5.mp3", "F#5": "Fs5.mp3", "A5": "A5.mp3",
                        },
                        release: 1,
                        baseUrl: "https://tonejs.github.io/audio/salamander/"
                    },
                    volume: -5
                };
            } else if (type === 'drums') {
                return {
                    type: 'PolySynth',
                    voice: Tone.MetalSynth,
                    options: {
                        envelope: { attack: 0.001, decay: 0.08, release: 0.02 }, 
                        harmonicity: 20, 
                        modulationIndex: 8, 
                        resonance: 4000, 
                        octaves: 1
                    },
                    volume: -10
                };
            } else if (type === 'lovecraft') {
                return {
                    type: 'PolySynth',
                    voice: Tone.FMSynth,
                    options: {
                        modulationIndex: 12.22, 
                        envelope: { attack: 0.01, decay: 0.2 },
                        modulation: { type: "square" },
                        oscillator: { type: "sawtooth" }
                    },
                    volume: -10
                };
            } else { // Synthwave (default)
                return {
                    type: 'PolySynth',
                    voice: Tone.Synth,
                    options: {
                        oscillator: { type: "fatsawtooth", count: 3, spread: 30 },
                        envelope: { attack: 0.01, decay: 0.1, sustain: 0.5, release: 0.4 }
                    },
                    volume: -8
                };
            }
        }

        async function initAudio() {
            if (!isAudioInit) {
                await Tone.start(); 
                await loadInstrument('piano');
                isAudioInit = true;
            }
        }

        async function loadInstrument(type) {
            selectedInstrument = type;
            
            let oldSynth = currentSynth;
            currentSynth = null; 
            if (oldSynth) {
                try {
                    oldSynth.releaseAll();
                    oldSynth.disconnect();
                    oldSynth.dispose();
                } catch(e) { console.warn("Cleanup error:", e); }
            }

            document.getElementById("status").innerText = "‚åõ LOADING INSTRUMENT...";
            const config = getInstrumentConfig(type);
            let tempSynth;

            try {
                if (config.type === 'Sampler') {
                    tempSynth = await new Promise(resolve => {
                        const s = new Tone.Sampler({
                            ...config.options,
                            onload: () => resolve(s)
                        }).toDestination();
                    });
                } else {
                    try {
                        tempSynth = new Tone.PolySynth(config.voice, config.options).toDestination();
                    } catch (polyError) {
                        console.warn("Complex synth failed, falling back to default:", polyError);
                        tempSynth = new Tone.PolySynth(Tone.Synth).toDestination();
                    }
                }
                
                if (tempSynth.volume) {
                    tempSynth.volume.value = config.volume;
                }
                
                currentSynth = tempSynth;
                document.getElementById("status").innerText = "‚úì INSTRUMENT READY";
                
            } catch (e) {
                console.error("Critical Instrument Load Error:", e);
                document.getElementById("status").innerText = "‚ö† LOAD ERROR. USING BACKUP.";
                currentSynth = new Tone.PolySynth(Tone.Synth).toDestination();
            }
        }

        window.changeInstrument = (val) => {
            if (isAudioInit) loadInstrument(val);
            else selectedInstrument = val;
        };

        window.js_play_note_on_contact = (note_name, duration) => {
            if (!currentSynth) return; 
            try {
                if (currentSynth.name === 'Sampler' && !currentSynth.loaded) return;
                currentSynth.triggerAttackRelease(note_name, duration);
            } catch (e) {
                // Silently ignore glitches during playback
            }
        };
        
        window.js_stop_all = () => {
            if (currentSynth) {
                try { currentSynth.releaseAll(); } catch(e) {}
            }
        };

        // --- WAV Export Logic (FIXED) ---
        window.downloadWav = async () => {
            // Check if Python function exists
            if (!window.py_get_notes) {
                alert("‚ö† Please load a MIDI file first!");
                return;
            }

            document.getElementById("status").innerText = "üéµ PREPARING AUDIO RENDER...";
            const btn = document.getElementById("btn-download");
            btn.disabled = true;
            btn.innerText = "‚è≥ PROCESSING...";

            try {
                // Get the note data from Python - this returns a JS object directly
                let songData = window.py_get_notes();
                
                console.log("Song data received (raw):", songData);
                console.log("Type of songData:", typeof songData);
                console.log("Song data keys:", Object.keys(songData));
                
                // Handle PyProxy if needed
                if (songData && typeof songData.toJs === 'function') {
                    console.log("Converting PyProxy to JS...");
                    songData = songData.toJs();
                }
                
                console.log("Song data after conversion:", songData);
                console.log("Notes array:", songData?.notes);
                console.log("Notes length:", songData?.notes?.length);

                if (!songData) {
                    alert("‚ö† Failed to retrieve MIDI data from Python.");
                    resetBtn();
                    return;
                }

                if (!songData.notes) {
                    alert("‚ö† MIDI data has no notes array.");
                    resetBtn();
                    return;
                }

                if (songData.notes.length === 0) {
                    alert("‚ö† No playable notes found in the MIDI data. Make sure your MIDI file contains note events.");
                    resetBtn();
                    return;
                }

                const config = getInstrumentConfig(selectedInstrument);
                
                document.getElementById("status").innerText = "üéπ RENDERING AUDIO...";

                const buffer = await Tone.Offline(async ({ transport }) => {
                    let synth;

                    try {
                        if (config.type === 'Sampler') {
                            synth = new Tone.Sampler(config.options).toDestination();
                            await Tone.loaded(); 
                        } else {
                            try {
                                synth = new Tone.PolySynth(config.voice, config.options).toDestination();
                            } catch(e) {
                                synth = new Tone.PolySynth(Tone.Synth).toDestination();
                            }
                        }
                    } catch (e) {
                         synth = new Tone.PolySynth(Tone.Synth).toDestination();
                    }
                    
                    if (synth.volume) {
                        synth.volume.value = config.volume;
                    }

                    songData.notes.forEach(n => {
                        synth.triggerAttackRelease(n.note, n.duration, n.time, n.velocity);
                    });

                }, songData.duration + 2); 

                document.getElementById("status").innerText = "üíæ ENCODING WAV...";
                const wavBlob = bufferToWave(buffer, 0, buffer.length);
                const url = URL.createObjectURL(wavBlob);
                
                const anchor = document.createElement("a");
                anchor.download = `90s_Midi_${selectedInstrument}_${Date.now()}.wav`; 
                anchor.href = url;
                anchor.click();
                
                document.getElementById("status").innerText = "‚úì DOWNLOAD COMPLETE!";
                setTimeout(() => {
                    document.getElementById("status").innerText = "‚ñ∫ READY TO JAM ‚óÑ";
                }, 3000);
            } catch (e) {
                console.error("Download error:", e);
                alert("‚ö† Error rendering audio: " + e.message);
                document.getElementById("status").innerText = "‚ö† RENDER FAILED";
            }
            
            resetBtn();
        };

        function resetBtn() {
            const btn = document.getElementById("btn-download");
            btn.disabled = false;
            btn.innerText = "üíæ SAVE WAV";
        }

        // --- WAV Encoder Helper ---
        function bufferToWave(abuffer, offset, len) {
            let numOfChan = abuffer.numberOfChannels,
                length = len * numOfChan * 2 + 44,
                buffer = new ArrayBuffer(length),
                view = new DataView(buffer),
                channels = [], i, sample,
                pos = 0;

            setUint32(0x46464952);                         // "RIFF"
            setUint32(length - 8);                         // file length - 8
            setUint32(0x45564157);                         // "WAVE"

            setUint32(0x20746d66);                         // "fmt " chunk
            setUint32(16);                                 // length = 16
            setUint16(1);                                  // PCM (uncompressed)
            setUint16(numOfChan);
            setUint32(abuffer.sampleRate);
            setUint32(abuffer.sampleRate * 2 * numOfChan); // avg. bytes/sec
            setUint16(numOfChan * 2);                      // block-align
            setUint16(16);                                 // 16-bit

            setUint32(0x61746164);                         // "data" - chunk
            setUint32(length - pos - 4);                   // chunk length

            for(i = 0; i < abuffer.numberOfChannels; i++)
                channels.push(abuffer.getChannelData(i));

            while(pos < length) {
                for(i = 0; i < numOfChan; i++) {             
                    sample = Math.max(-1, Math.min(1, channels[i][offset])); 
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767)|0; 
                    view.setInt16(pos, sample, true);          
                    pos += 2;
                }
                offset++                                     
            }

            return new Blob([buffer], {type: "audio/wav"});

            function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
            function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }
        }

        const canvas = document.getElementById('visualizer');
        const container = document.getElementById('canvas-container');
        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
    </script>

    <!-- Python Logic (FIXED) -->
    <script type="py">
        import asyncio
        import io
        import mido
        from js import document, window, Uint8Array, requestAnimationFrame, console
        from pyodide.ffi import create_proxy

        # --- Globals ---
        canvas = document.getElementById("visualizer")
        ctx = canvas.getContext("2d")
        
        midi_events = []      
        active_keys = set()   
        is_playing = False
        start_time_real = 0.0
        
        NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B']
        WHITE_KEYS = [0, 2, 4, 5, 7, 9, 11]
        PIANO_HEIGHT = 100
        SCROLL_TIME = 2.0
        NOTE_BAR_HEIGHT = 30

        def midi_to_name(note):
            n = NOTE_NAMES[note % 12]
            o = (note // 12) - 1
            return f"{n}{o}"

        # --- MIDI Parsing ---
        async def on_file_change(event):
            global midi_events
            file_list = event.target.files
            if not file_list: return

            file = file_list.item(0)
            document.getElementById("status").innerText = "üìÄ PARSING MIDI FILE..."
            array_buf = await file.arrayBuffer()
            py_bytes = bytes(Uint8Array.new(array_buf))
            
            try:
                mid = mido.MidiFile(file=io.BytesIO(py_bytes))
                midi_events = []
                abs_time = 0.0
                
                console.log(f"MIDI file loaded: {len(mid.tracks)} tracks")
                
                if len(mid.tracks) > 1:
                    mid.tracks = [mido.merge_tracks(mid.tracks)]

                note_count = 0
                for msg in mid:
                    abs_time += msg.time
                    midi_events.append({'time': abs_time, 'msg': msg, 'played': False})
                    if hasattr(msg, 'type') and msg.type in ['note_on', 'note_off']:
                        note_count += 1
                
                console.log(f"Parsed {len(midi_events)} total events, {note_count} note events")
                document.getElementById("status").innerText = f"‚úì LOADED: {file.name[:30]} ({note_count} notes)"
            except Exception as e:
                console.log(f"MIDI parse error: {e}")
                document.getElementById("status").innerText = f"‚ö† ERROR: {e}"

        # --- Export Data (FIXED TO RETURN JS OBJECT) ---
        def get_notes_for_export():
            """Returns a plain JavaScript object with notes data"""
            console.log(f"Python: get_notes_for_export called, midi_events length: {len(midi_events)}")
            
            if not midi_events:
                console.log("Python: No MIDI events found")
                return {"duration": 0, "notes": []}

            notes = []
            active_notes = {} 
            total_time = 0

            for evt in midi_events:
                abs_time = evt['time']
                msg = evt['msg']
                total_time = max(total_time, abs_time)
                
                # Check if msg has the required attributes
                if hasattr(msg, 'type') and hasattr(msg, 'note'):
                    if msg.type == 'note_on' and msg.velocity > 0:
                        active_notes[msg.note] = {'start': abs_time, 'vel': msg.velocity / 127.0}
                    elif (msg.type == 'note_off') or (msg.type == 'note_on' and msg.velocity == 0):
                        if msg.note in active_notes:
                            start_data = active_notes.pop(msg.note)
                            duration = abs_time - start_data['start']
                            if duration > 0:  # Only add notes with positive duration
                                notes.append({
                                    "note": midi_to_name(msg.note),
                                    "time": start_data['start'],
                                    "duration": duration,
                                    "velocity": start_data['vel']
                                })
            
            # Return as a Python dict - Pyodide will automatically convert it to a JS object
            result = {"duration": total_time, "notes": notes}
            console.log(f"Python: Returning {len(notes)} notes, duration {total_time}")
            return result

        # Expose the function to JavaScript
        window.py_get_notes = create_proxy(get_notes_for_export)

        # --- Visualizer ---
        def get_piano_layout(screen_width):
            total_white_keys = 52
            key_width = screen_width / total_white_keys
            keys = {} 
            white_key_index = 0
            for note in range(21, 109):
                octave_idx = note % 12
                is_black = octave_idx not in WHITE_KEYS
                if not is_black:
                    x = white_key_index * key_width
                    keys[note] = {'x': x, 'w': key_width, 'black': False, 'h': PIANO_HEIGHT}
                    white_key_index += 1
                else:
                    prev_white_x = (white_key_index - 1) * key_width
                    b_w = key_width * 0.6
                    x = (prev_white_x + key_width) - (b_w / 2)
                    keys[note] = {'x': x, 'w': b_w, 'black': True, 'h': PIANO_HEIGHT * 0.65}
            return keys

        def animation_frame(timestamp):
            if is_playing:
                update_and_draw()
                requestAnimationFrame(create_proxy(animation_frame))

        def update_and_draw():
            global is_playing, active_keys
            now = window.performance.now() / 1000.0
            song_time = now - start_time_real
            
            w = canvas.width
            h = canvas.height
            key_layout = get_piano_layout(w)
            
            # Cosmic background
            ctx.fillStyle = "#000000"
            ctx.fillRect(0, 0, w, h)
            
            fall_height_area = h - PIANO_HEIGHT
            
            # Draw falling notes and trigger audio on contact
            for idx, evt in enumerate(midi_events):
                evt_time = evt['time']
                msg = evt['msg']
                time_diff = evt_time - song_time
                
                if time_diff < SCROLL_TIME and msg.type == 'note_on' and msg.velocity > 0:
                    note = msg.note
                    if note in key_layout:
                        k = key_layout[note]
                        y_pos_top = (1 - (time_diff / SCROLL_TIME)) * fall_height_area 
                        y_pos_bottom = y_pos_top + NOTE_BAR_HEIGHT

                        hue = (note * 7) % 360
                        
                        # Draw note with glow
                        ctx.fillStyle = f"hsl({hue}, 100%, 60%)"
                        ctx.shadowBlur = 15
                        ctx.shadowColor = f"hsl({hue}, 100%, 50%)"
                        ctx.fillRect(k['x'], y_pos_top, k['w'], NOTE_BAR_HEIGHT)
                        ctx.shadowBlur = 0

                        # Trigger audio on contact
                        if not evt['played'] and y_pos_bottom >= fall_height_area:
                            window.js_play_note_on_contact(midi_to_name(note), 2.0)
                            active_keys.add(note)
                            evt['played'] = True

                # Note offs
                if time_diff < 0 and (msg.type == 'note_off' or (msg.type == 'note_on' and msg.velocity == 0)):
                    if msg.note in active_keys: 
                        active_keys.remove(msg.note)

            # Draw white keys
            for note in range(21, 109):
                if note not in key_layout: continue
                k = key_layout[note]
                if not k['black']:
                    is_active = note in active_keys
                    
                    if is_active:
                        ctx.fillStyle = "#00ff00"
                        ctx.shadowBlur = 20
                        ctx.shadowColor = "#00ff00"
                    else:
                        ctx.fillStyle = "#e0e0e0"
                        ctx.shadowBlur = 0
                    
                    ctx.fillRect(k['x'], h - k['h'], k['w'], k['h'])
                    
                    ctx.strokeStyle = "#000000"
                    ctx.lineWidth = 2
                    ctx.strokeRect(k['x'], h - k['h'], k['w'], k['h'])
                    ctx.shadowBlur = 0

            # Draw black keys
            for note in range(21, 109):
                if note not in key_layout: continue
                k = key_layout[note]
                if k['black']:
                    is_active = note in active_keys
                    
                    if is_active:
                        ctx.fillStyle = "#ff00ff"
                        ctx.shadowBlur = 20
                        ctx.shadowColor = "#ff00ff"
                    else:
                        ctx.fillStyle = "#1a1a1a"
                        ctx.shadowBlur = 0
                    
                    ctx.fillRect(k['x'], h - PIANO_HEIGHT, k['w'], k['h'])
                    
                    ctx.strokeStyle = "#00ff00"
                    ctx.lineWidth = 1
                    ctx.strokeRect(k['x'], h - PIANO_HEIGHT, k['w'], k['h'])
                    ctx.shadowBlur = 0

        async def play_midi(event):
            global is_playing, start_time_real, active_keys
            if not midi_events: return

            await window.initAudio()
            active_keys.clear()
            
            for evt in midi_events:
                evt['played'] = False

            is_playing = True
            start_time_real = window.performance.now() / 1000.0
            
            document.getElementById("btn-play").disabled = True
            document.getElementById("btn-stop").disabled = False
            document.getElementById("status").innerText = "‚ñ∂ NOW PLAYING!"
            requestAnimationFrame(create_proxy(animation_frame))

        def stop_midi(event):
            global is_playing
            is_playing = False
            window.js_stop_all()
            document.getElementById("btn-play").disabled = False
            document.getElementById("btn-stop").disabled = True
            document.getElementById("status").innerText = "‚èπ STOPPED"
            
            w = canvas.width
            h = canvas.height
            ctx.fillStyle = "#000000"
            ctx.fillRect(0, 0, w, h - PIANO_HEIGHT)
            update_and_draw()
            active_keys.clear()

        document.getElementById("midi-upload").addEventListener("change", create_proxy(on_file_change))
        document.getElementById("btn-play").addEventListener("click", create_proxy(play_midi))
        document.getElementById("btn-stop").addEventListener("click", create_proxy(stop_midi))
        document.getElementById("status").innerText = "‚ñ∫ READY TO JAM ‚óÑ"
    </script>
</body>
</html>
